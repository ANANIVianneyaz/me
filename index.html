<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mon Espace Personnel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Styles personnalisés */
        body {
            font-family: 'Inter', sans-serif;
        }
        .draggable {
            cursor: grab; /* Curseur pour indiquer que l'élément est déplaçable */
            user-select: none;
        }
        .dragging {
            opacity: 0.5;
            background-color: rgba(168, 85, 247, 0.2);
            border: 2px dashed #9333ea;
        }
        .category-color {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            vertical-align: middle;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Style pour les éléments glissés-déposés */
        .drag-over-top {
            border-top: 2px solid #a78bfa; /* Couleur violette claire */
        }
        .drag-over-bottom {
            border-bottom: 2px solid #a78bfa; /* Couleur violette claire */
        }
        /* Styles pour les champs de formulaire en mode édition */
        [contenteditable="true"]:focus {
            outline: 2px solid #a78bfa; /* Anneau de focus violet */
            border-radius: 4px;
            padding: 2px 4px;
        }
        /* Style pour les sections pliables */
        details summary {
            cursor: pointer;
            padding: 8px 0;
            font-weight: 600;
            color: #6b21a8; /* purple-800 */
            list-style: none; /* Remove default arrow */
        }
        details summary::-webkit-details-marker {
            display: none;
        }
        details summary::before {
            content: "\f078"; /* FontAwesome chevron-down */
            font-family: "Font Awesome 5 Pro";
            font-weight: 900;
            margin-right: 0.75rem;
            transition: transform 0.2s ease-in-out;
            display: inline-block;
        }
        details[open] summary::before {
            transform: rotate(180deg);
        }
        /* Styles pour les conteneurs de graphiques pour éviter l'étirement */
        .chart-container {
            position: relative;
            height: 200px; /* Fixed height for consistent chart size */
            width: 100%;
        }
        /* Custom modal for messages */
        .custom-modal {
            background-color: white;
            border-radius: 0.75rem; /* rounded-xl */
            padding: 1.5rem; /* p-6 */
            width: 100%;
            max-width: 28rem; /* max-w-md */
            text-align: center;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .custom-modal-backdrop {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100; /* Ensure it's on top */
        }
    </style>
</head>
<body class="bg-purple-50 min-h-screen font-sans">
    <div class="container mx-auto px-4 py-8">
        <header class="flex flex-col sm:flex-row justify-between items-center mb-8 space-y-4 sm:space-y-0">
            <div>
                <h1 class="text-3xl font-bold text-purple-800">Mon Espace Personnel</h1>
                <p class="text-purple-600">Tout ce dont vous avez besoin au même endroit</p>
            </div>
            <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-4 w-full sm:w-auto">
                <button id="exportBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition w-full sm:w-auto">
                    <i class="fas fa-download mr-2"></i>Exporter
                </button>
                <button id="importBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition w-full sm:w-auto">
                    <i class="fas fa-upload mr-2"></i>Importer
                </button>
                <button id="exportPdfBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition w-full sm:w-auto">
                    <i class="fas fa-file-pdf mr-2"></i>Exporter PDF
                </button>
                <input type="file" id="fileInput" class="hidden" accept=".json">
            </div>
        </header>

        <div id="githubConfigSection" class="bg-white rounded-xl shadow-md p-6 mb-6 hidden">
            <h2 class="text-xl font-semibold text-purple-800 mb-4">Configuration GitHub</h2>
            <p class="text-red-600 mb-4">
                <strong>Attention :</strong> Pour des raisons de simplicité, votre Personal Access Token (PAT) sera stocké dans le stockage local de votre navigateur.
                Cela signifie qu'il est accessible via les outils de développement du navigateur. N'utilisez cette fonction que pour un usage strictement personnel.
                Créez un PAT avec les permissions minimales (repo scope) sur GitHub.
            </p>
            <div class="space-y-4">
                <div>
                    <label for="githubUsername" class="block text-sm font-medium text-purple-700 mb-1">Nom d'utilisateur GitHub</label>
                    <input type="text" id="githubUsername" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="Votre nom d'utilisateur GitHub">
                </div>
                <div>
                    <label for="githubRepo" class="block text-sm font-medium text-purple-700 mb-1">Nom du dépôt GitHub</label>
                    <input type="text" id="githubRepo" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="Nom du dépôt (ex: my-personal-data)">
                </div>
                <div>
                    <label for="githubToken" class="block text-sm font-medium text-purple-700 mb-1">Personal Access Token (PAT) GitHub</label>
                    <input type="password" id="githubToken" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="ghp_XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX">
                </div>
                <div class="flex justify-end">
                    <button id="saveGithubConfigBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition">
                        <i class="fas fa-save mr-2"></i>Enregistrer la configuration
                    </button>
                </div>
            </div>
        </div>
        <div id="githubStatus" class="bg-purple-100 text-purple-800 p-3 rounded-lg mb-6 hidden">
            <i class="fas fa-info-circle mr-2"></i>
            <span id="githubStatusMessage"></span>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
            <div class="lg:col-span-1 bg-white rounded-xl shadow-md p-6 h-fit sticky top-6">
                <div class="mb-6">
                    <h2 class="text-xl font-semibold text-purple-800 mb-4">Sections</h2>
                    <ul class="space-y-2">
                        <li>
                            <button data-section="overview" class="section-btn w-full text-left px-4 py-2 rounded-lg hover:bg-purple-50 text-purple-700 font-medium flex items-center">
                                <i class="fas fa-chart-pie mr-3"></i> Vue d'ensemble
                            </button>
                        </li>
                        <li>
                            <button data-section="todos" class="section-btn w-full text-left px-4 py-2 rounded-lg bg-purple-100 text-purple-800 font-medium flex items-center">
                                <i class="fas fa-tasks mr-3"></i> Tâches
                            </button>
                        </li>
                        <li>
                            <button data-section="notes" class="section-btn w-full text-left px-4 py-2 rounded-lg hover:bg-purple-50 text-purple-700 font-medium flex items-center">
                                <i class="fas fa-sticky-note mr-3"></i> Notes
                            </button>
                        </li>
                        <li>
                            <button data-section="expenses" class="section-btn w-full text-left px-4 py-2 rounded-lg hover:bg-purple-50 text-purple-700 font-medium flex items-center">
                                <i class="fas fa-wallet mr-3"></i> Dépenses & Finances
                            </button>
                        </li>
                        <li>
                            <button data-section="wellness" class="section-btn w-full text-left px-4 py-2 rounded-lg hover:bg-purple-50 text-purple-700 font-medium flex items-center">
                                <i class="fas fa-heartbeat mr-3"></i> Bien-être
                            </button>
                        </li>
                        <li>
                            <button data-section="salary-forecast" class="section-btn w-full text-left px-4 py-2 rounded-lg hover:bg-purple-50 text-purple-700 font-medium flex items-center">
                                <i class="fas fa-money-bill-wave mr-3"></i> Prévision Salariale
                            </button>
                        </li>
                        <li>
                            <button data-section="planned-expenses" class="section-btn w-full text-left px-4 py-2 rounded-lg hover:bg-purple-50 text-purple-700 font-medium flex items-center">
                                <i class="fas fa-clipboard-list mr-3"></i> Dépenses Planifiées
                            </button>
                        </li>
                    </ul>
                </div>
                
                <details class="mb-6" open>
                    <summary class="text-xl font-semibold text-purple-800 mb-4">Catégories</summary>
                    <div id="categories-list-display" class="space-y-2 mb-4 mt-2">
                        </div>
                    <button id="addCategoryBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition flex items-center justify-center">
                        <i class="fas fa-plus mr-2"></i> Nouvelle Catégorie
                    </button>
                </details>

                <details class="mb-6" open>
                    <summary class="text-xl font-semibold text-purple-800 mb-4">Provenances</summary>
                    <div id="origins-list-display" class="space-y-2 mb-4 mt-2">
                        </div>
                    <button id="addOriginBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition flex items-center justify-center">
                        <i class="fas fa-plus mr-2"></i> Nouvelle Provenance
                    </button>
                </details>
            </div>

            <div class="lg:col-span-3 space-y-6">
                <div id="overview-section" class="section-content bg-white rounded-xl shadow-md p-6 hidden fade-in">
                    <h2 class="text-2xl font-bold text-purple-800 mb-6">Vue d'ensemble</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="bg-purple-100 p-4 rounded-lg text-center">
                            <i class="fas fa-tasks text-3xl text-purple-600 mb-2"></i>
                            <p class="text-sm text-purple-600">Total Tâches Actives</p>
                            <p id="overviewActiveTasks" class="text-2xl font-bold text-purple-800">0</p>
                        </div>
                        <div class="bg-purple-100 p-4 rounded-lg text-center">
                            <i class="fas fa-check-circle text-3xl text-purple-600 mb-2"></i>
                            <p class="text-sm text-purple-600">Taux de Complétion Tâches</p>
                            <p id="overviewTaskCompletion" class="text-2xl font-bold text-purple-800">0%</p>
                        </div>
                        <div class="bg-purple-100 p-4 rounded-lg text-center">
                            <i class="fas fa-heartbeat text-3xl text-purple-600 mb-2"></i>
                            <p class="text-sm text-purple-600">Indice de Bien-être</p>
                            <p id="overviewWellnessIndex" class="text-2xl font-bold text-purple-800">N/A</p>
                        </div>
                        <div class="bg-purple-100 p-4 rounded-lg text-center cursor-pointer" id="overviewCurrentBalanceCard">
                            <i class="fas fa-euro-sign text-3xl text-purple-600 mb-2"></i>
                            <p class="text-sm text-purple-600">Solde Actuel</p>
                            <p id="overviewCurrentBalance" class="text-2xl font-bold text-purple-800">€0.00</p>
                        </div>
                        <div class="bg-purple-100 p-4 rounded-lg text-center cursor-pointer" id="overviewSavingsBalanceCard">
                            <i class="fas fa-piggy-bank text-3xl text-purple-600 mb-2"></i>
                            <p class="text-sm text-purple-600">Total Épargne</p>
                            <p id="overviewSavingsBalance" class="text-2xl font-bold text-purple-800">€0.00</p>
                        </div>
                        <div class="bg-purple-100 p-4 rounded-lg text-center">
                            <i class="fas fa-hand-holding-usd text-3xl text-purple-600 mb-2"></i>
                            <p class="text-sm text-purple-600">Total Prêts Restants</p>
                            <p id="overviewLoansRemaining" class="text-2xl font-bold text-purple-800">€0.00</p>
                        </div>
                    </div>
                    <div class="mt-8">
                        <h3 class="text-xl font-semibold text-purple-800 mb-4">Répartition des Dépenses</h3>
                        <div class="chart-container">
                            <canvas id="expenseCategoryChart"></canvas>
                        </div>
                    </div>
                </div>

                <div id="todos-section" class="section-content bg-white rounded-xl shadow-md p-6 fade-in">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 space-y-4 sm:space-y-0">
                        <h2 class="text-2xl font-bold text-purple-800">Mes Tâches</h2>
                        <button id="addTodoBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition flex items-center w-full sm:w-auto justify-center">
                            <i class="fas fa-plus mr-2"></i> Nouvelle Tâche (<span id="tasksProgressText">0/0</span>)
                        </button>
                    </div>
                    
                    <div class="mb-6">
                        <div class="flex space-x-2 overflow-x-auto scrollbar-hide pb-2">
                            <button data-filter="all" class="todo-filter-btn flex-shrink-0 px-4 py-1 rounded-full bg-purple-600 text-white text-sm">Toutes</button>
                            <button data-filter="active" class="todo-filter-btn flex-shrink-0 px-4 py-1 rounded-full bg-purple-100 text-purple-800 text-sm">Actives</button>
                            <button data-filter="completed" class="todo-filter-btn flex-shrink-0 px-4 py-1 rounded-full bg-purple-100 text-purple-800 text-sm">Terminées</button>
                            <button data-filter="today" class="todo-filter-btn flex-shrink-0 px-4 py-1 rounded-full bg-purple-100 text-purple-800 text-sm">Aujourd'hui</button>
                            <button data-filter="thisWeek" class="todo-filter-btn flex-shrink-0 px-4 py-1 rounded-full bg-purple-100 text-purple-800 text-sm">Cette Semaine</button>
                            <button data-filter="thisMonth" class="todo-filter-btn flex-shrink-0 px-4 py-1 rounded-full bg-purple-100 text-purple-800 text-sm">Ce Mois</button>
                        </div>
                    </div>
                    
                    <div id="todos-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        </div>
                </div>

                <div id="notes-section" class="section-content bg-white rounded-xl shadow-md p-6 hidden fade-in">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 space-y-4 sm:space-y-0">
                        <h2 class="text-2xl font-bold text-purple-800">Mes Notes</h2>
                        <div class="flex space-x-2 w-full sm:w-auto">
                            <button id="addNoteBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition flex items-center justify-center flex-1">
                                <i class="fas fa-plus mr-2"></i> Nouvelle Note
                            </button>
                            <button id="addListBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition flex items-center justify-center flex-1">
                                <i class="fas fa-list mr-2"></i> Nouvelle Liste
                            </button>
                        </div>
                    </div>
                    
                    <div id="notes-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        </div>
                </div>

                <div id="expenses-section" class="section-content bg-white rounded-xl shadow-md p-6 hidden fade-in">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 space-y-4 sm:space-y-0">
                        <h2 class="text-2xl font-bold text-purple-800">Mes Dépenses & Finances</h2>
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 w-full sm:w-auto">
                            <button id="addExpenseBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition flex items-center justify-center flex-1">
                                <i class="fas fa-plus mr-2"></i> Nouvelle Dépense
                            </button>
                            <button id="addIncomeBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition flex items-center justify-center flex-1">
                                <i class="fas fa-dollar-sign mr-2"></i> Ajouter Revenu
                            </button>
                            <button id="addLoanBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition flex items-center justify-center flex-1">
                                <i class="fas fa-hand-holding-usd mr-2"></i> Nouveau Prêt
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-6 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="bg-purple-100 p-4 rounded-lg text-center cursor-pointer" id="currentBalanceCard">
                            <i class="fas fa-euro-sign text-3xl text-purple-600 mb-2"></i>
                            <p class="text-sm text-purple-600">Solde Actuel</p>
                            <p id="currentBalance" class="text-2xl font-bold text-purple-800">€0.00</p>
                        </div>
                        <div class="bg-purple-100 p-4 rounded-lg text-center cursor-pointer" id="totalSavingsCard">
                            <i class="fas fa-piggy-bank text-3xl text-purple-600 mb-2"></i>
                            <p class="text-sm text-purple-600">Épargne Totale</p>
                            <p id="totalSavings" class="text-2xl font-bold text-purple-800">€0.00</p>
                        </div>
                        <div class="bg-purple-100 p-4 rounded-lg text-center">
                            <i class="fas fa-hand-holding-usd text-3xl text-purple-600 mb-2"></i>
                            <p class="text-sm text-purple-600">Prêts Restants</p>
                            <p id="totalLoansRemaining" class="text-2xl font-bold text-purple-800">€0.00</p>
                        </div>
                    </div>

                    <div class="mb-6">
                        <div class="flex space-x-2 overflow-x-auto scrollbar-hide pb-2">
                            <button data-filter="all" class="expense-filter-btn flex-shrink-0 px-4 py-1 rounded-full bg-purple-600 text-white text-sm">Toutes</button>
                            <button data-filter="thisMonth" class="expense-filter-btn flex-shrink-0 px-4 py-1 rounded-full bg-purple-100 text-purple-800 text-sm">Ce Mois</button>
                            <button data-filter="thisWeek" class="expense-filter-btn flex-shrink-0 px-4 py-1 rounded-full bg-purple-100 text-purple-800 text-sm">Cette Semaine</button>
                        </div>
                    </div>
                    
                    <h3 class="text-xl font-semibold text-purple-800 mb-4">Historique des Dépenses</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="text-left text-purple-800 border-b">
                                    <th class="pb-2">Date</th>
                                    <th class="pb-2">Description</th>
                                    <th class="pb-2">Catégorie</th>
                                    <th class="pb-2">Provenance</th>
                                    <th class="pb-2 text-right">Montant</th>
                                    <th class="pb-2">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="expenses-container">
                                </tbody>
                        </table>
                    </div>

                    <h3 class="text-xl font-semibold text-purple-800 mt-8 mb-4">Mes Prêts</h3>
                    <div id="loans-container" class="space-y-4">
                        </div>
                </div>

                <div id="wellness-section" class="section-content bg-white rounded-xl shadow-md p-6 hidden fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-purple-800">Mon Bien-être</h2>
                        <button id="addWellnessBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition flex items-center">
                            <i class="fas fa-plus mr-2"></i> Nouvelle Entrée
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="bg-purple-100 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-purple-800 mb-2">Suivi de Poids</h3>
                            <div class="chart-container">
                                <canvas id="weightChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-purple-100 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-purple-800 mb-2">Humeur</h3>
                            <div class="chart-container">
                                <canvas id="moodChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-purple-100 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-purple-800 mb-2">Sommeil (heures)</h3>
                            <div class="chart-container">
                                <canvas id="sleepChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-purple-100 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-purple-800 mb-2">Exercice (minutes)</h3>
                            <div class="chart-container">
                                <canvas id="exerciseChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-purple-100 p-4 rounded-lg">
                            <h3 class="text-lg font-semibold text-purple-800 mb-2">Consommation d'eau (verres)</h3>
                            <div class="chart-container">
                                <canvas id="waterChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div id="wellness-container" class="space-y-4">
                        </div>
                </div>

                <div id="salary-forecast-section" class="section-content bg-white rounded-xl shadow-md p-6 hidden fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-purple-800">Prévisions Salariale</h2>
                        <button id="addSalaryForecastBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition flex items-center">
                            <i class="fas fa-plus mr-2"></i> Nouvelle Prévision
                        </button>
                    </div>
                    <div id="salary-forecast-container" class="space-y-4">
                        </div>
                </div>

                <div id="planned-expenses-section" class="section-content bg-white rounded-xl shadow-md p-6 hidden fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-purple-800">Dépenses Planifiées</h2>
                        <button id="addPlannedExpenseBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition flex items-center">
                            <i class="fas fa-plus mr-2"></i> Nouvelle Dépense Planifiée
                        </button>
                    </div>
                    <div id="planned-expenses-container" class="space-y-4">
                        </div>
                </div>

            </div>
        </div>
    </div>

    <div id="todoModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-purple-800">Nouvelle Tâche</h3>
                <button id="closeTodoModal" class="text-purple-600 hover:text-purple-800">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="todoForm" class="space-y-4">
                <input type="hidden" id="todoId">
                <div>
                    <label for="todoTitle" class="block text-sm font-medium text-purple-700 mb-1">Titre</label>
                    <input type="text" id="todoTitle" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                </div>
                <div>
                    <label for="todoDescription" class="block text-sm font-medium text-purple-700 mb-1">Description</label>
                    <textarea id="todoDescription" rows="3" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"></textarea>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="todoDueDate" class="block text-sm font-medium text-purple-700 mb-1">Date limite</label>
                        <input type="date" id="todoDueDate" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                    </div>
                    <div>
                        <label for="todoPriority" class="block text-sm font-medium text-purple-700 mb-1">Priorité</label>
                        <select id="todoPriority" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                            <option value="low">Basse</option>
                            <option value="medium">Moyenne</option>
                            <option value="high">Haute</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label for="todoCategory" class="block text-sm font-medium text-purple-700 mb-1">Catégorie</label>
                    <select id="todoCategory" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                        </select>
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="cancelTodo" class="px-4 py-2 border border-purple-300 text-purple-700 rounded-lg hover:bg-purple-50">Annuler</button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <div id="noteModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-purple-800">Nouvelle Note</h3>
                <button id="closeNoteModal" class="text-purple-600 hover:text-purple-800">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="noteForm" class="space-y-4">
                <input type="hidden" id="noteId">
                <div>
                    <label for="noteTitle" class="block text-sm font-medium text-purple-700 mb-1">Titre</label>
                    <input type="text" id="noteTitle" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                </div>
                <div>
                    <label for="noteContent" class="block text-sm font-medium text-purple-700 mb-1">Contenu</label>
                    <textarea id="noteContent" rows="5" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"></textarea>
                </div>
                <div>
                    <label for="noteColor" class="block text-sm font-medium text-purple-700 mb-1">Couleur</label>
                    <select id="noteColor" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                        <option value="bg-purple-100">Violet</option>
                        <option value="bg-blue-100">Bleu</option>
                        <option value="bg-green-100">Vert</option>
                        <option value="bg-yellow-100">Jaune</option>
                        <option value="bg-red-100">Rouge</option>
                        <option value="bg-pink-100">Rose</option>
                        <option value="bg-gray-100">Gris</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="cancelNote" class="px-4 py-2 border border-purple-300 text-purple-700 rounded-lg hover:bg-purple-50">Annuler</button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <div id="listModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-purple-800">Nouvelle Liste</h3>
                <button id="closeListModal" class="text-purple-600 hover:text-purple-800">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="listForm" class="space-y-4">
                <input type="hidden" id="listId">
                <div>
                    <label for="listTitle" class="block text-sm font-medium text-purple-700 mb-1">Titre</label>
                    <input type="text" id="listTitle" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                </div>
                <div>
                    <label for="listColor" class="block text-sm font-medium text-purple-700 mb-1">Couleur</label>
                    <select id="listColor" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                        <option value="bg-purple-100">Violet</option>
                        <option value="bg-blue-100">Bleu</option>
                        <option value="bg-green-100">Vert</option>
                        <option value="bg-yellow-100">Jaune</option>
                        <option value="bg-red-100">Rouge</option>
                        <option value="bg-pink-100">Rose</option>
                        <option value="bg-gray-100">Gris</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-purple-700 mb-1">Éléments</label>
                    <div id="listItemsContainer" class="space-y-2 mb-2">
                        </div>
                    <button type="button" id="addListItem" class="text-sm text-purple-600 hover:text-purple-800 flex items-center">
                        <i class="fas fa-plus mr-1"></i> Ajouter un élément
                    </button>
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="cancelList" class="px-4 py-2 border border-purple-300 text-purple-700 rounded-lg hover:bg-purple-50">Annuler</button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <div id="expenseModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-purple-800">Nouvelle Dépense</h3>
                <button id="closeExpenseModal" class="text-purple-600 hover:text-purple-800">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="expenseForm" class="space-y-4">
                <input type="hidden" id="expenseId">
                <div>
                    <label for="expenseDate" class="block text-sm font-medium text-purple-700 mb-1">Date</label>
                    <input type="date" id="expenseDate" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                </div>
                <div>
                    <label for="expenseDescription" class="block text-sm font-medium text-purple-700 mb-1">Description</label>
                    <input type="text" id="expenseDescription" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                </div>
                <div>
                    <label for="expenseCategory" class="block text-sm font-medium text-purple-700 mb-1">Catégorie</label>
                    <select id="expenseCategory" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                        </select>
                </div>
                <div>
                    <label for="expenseOrigin" class="block text-sm font-medium text-purple-700 mb-1">Provenance</label>
                    <select id="expenseOrigin" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                        </select>
                </div>
                <div>
                    <label for="expenseAmount" class="block text-sm font-medium text-purple-700 mb-1">Montant (€)</label>
                    <input type="number" step="0.01" id="expenseAmount" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="cancelExpense" class="px-4 py-2 border border-purple-300 text-purple-700 rounded-lg hover:bg-purple-50">Annuler</button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <div id="incomeModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-purple-800">Ajouter Revenu</h3>
                <button id="closeIncomeModal" class="text-purple-600 hover:text-purple-800">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="incomeForm" class="space-y-4">
                <div>
                    <label for="incomeDate" class="block text-sm font-medium text-purple-700 mb-1">Date</label>
                    <input type="date" id="incomeDate" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                </div>
                <div>
                    <label for="incomeDescription" class="block text-sm font-medium text-purple-700 mb-1">Description</label>
                    <input type="text" id="incomeDescription" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                </div>
                <div>
                    <label for="incomeOrigin" class="block text-sm font-medium text-purple-700 mb-1">Provenance</label>
                    <select id="incomeOrigin" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                        </select>
                </div>
                <div>
                    <label for="incomeAmount" class="block text-sm font-medium text-purple-700 mb-1">Montant (€)</label>
                    <input type="number" step="0.01" id="incomeAmount" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="cancelIncome" class="px-4 py-2 border border-purple-300 text-purple-700 rounded-lg hover:bg-purple-50">Annuler</button>
                    <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">Ajouter</button>
                </div>
            </form>
        </div>
    </div>

    <div id="wellnessModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-purple-800">Nouvelle Entrée Bien-être</h3>
                <button id="closeWellnessModal" class="text-purple-600 hover:text-purple-800">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="wellnessForm" class="space-y-4">
                <input type="hidden" id="wellnessId">
                <div>
                    <label for="wellnessDate" class="block text-sm font-medium text-purple-700 mb-1">Date</label>
                    <input type="date" id="wellnessDate" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                </div>
                <div>
                    <label for="wellnessType" class="block text-sm font-medium text-purple-700 mb-1">Type</label>
                    <select id="wellnessType" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                        <option value="weight">Poids</option>
                        <option value="mood">Humeur</option>
                        <option value="sleep">Sommeil</option>
                        <option value="exercise">Exercice</option>
                        <option value="water">Eau</option>
                    </select>
                </div>
                <div id="wellnessValueContainer">
                    <label for="wellnessValue" class="block text-sm font-medium text-purple-700 mb-1">Valeur</label>
                    <input type="number" id="wellnessValue" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                </div>
                <div id="wellnessMoodContainer" class="hidden">
                    <label class="block text-sm font-medium text-purple-700 mb-1">Humeur</label>
                    <div class="flex justify-between">
                        <button type="button" data-mood="1" class="mood-btn p-2 rounded-full hover:bg-purple-50">
                            <i class="fas fa-frown text-red-500 text-2xl"></i>
                        </button>
                        <button type="button" data-mood="2" class="mood-btn p-2 rounded-full hover:bg-purple-50">
                            <i class="fas fa-meh text-yellow-500 text-2xl"></i>
                        </button>
                        <button type="button" data-mood="3" class="mood-btn p-2 rounded-full hover:bg-purple-50">
                            <i class="fas fa-smile text-green-500 text-2xl"></i>
                        </button>
                        <button type="button" data-mood="4" class="mood-btn p-2 rounded-full hover:bg-purple-50">
                            <i class="fas fa-laugh text-blue-500 text-2xl"></i>
                        </button>
                        <button type="button" data-mood="5" class="mood-btn p-2 rounded-full hover:bg-purple-50">
                            <i class="fas fa-grin-hearts text-purple-500 text-2xl"></i>
                        </button>
                    </div>
                    <input type="hidden" id="wellnessMood" required>
                </div>
                <div>
                    <label for="wellnessNotes" class="block text-sm font-medium text-purple-700 mb-1">Notes</label>
                    <textarea id="wellnessNotes" rows="3" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500"></textarea>
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="cancelWellness" class="px-4 py-2 border border-purple-300 text-purple-700 rounded-lg hover:bg-purple-50">Annuler</button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <div id="categoryModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-purple-800">Nouvelle Catégorie</h3>
                <button id="closeCategoryModal" class="text-purple-600 hover:text-purple-800">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="categoryForm" class="space-y-4">
                <input type="hidden" id="categoryId">
                <div>
                    <label for="categoryName" class="block text-sm font-medium text-purple-700 mb-1">Nom</label>
                    <input type="text" id="categoryName" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                </div>
                <div>
                    <label for="categoryColor" class="block text-sm font-medium text-purple-700 mb-1">Couleur</label>
                    <input type="color" id="categoryColor" value="#9333ea" class="w-full h-10 cursor-pointer">
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="cancelCategory" class="px-4 py-2 border border-purple-300 text-purple-700 rounded-lg hover:bg-purple-50">Annuler</button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <div id="originModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-purple-800">Nouvelle Provenance</h3>
                <button id="closeOriginModal" class="text-purple-600 hover:text-purple-800">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="originForm" class="space-y-4">
                <input type="hidden" id="originId">
                <div>
                    <label for="originName" class="block text-sm font-medium text-purple-700 mb-1">Nom</label>
                    <input type="text" id="originName" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                </div>
                <div>
                    <label for="originColor" class="block text-sm font-medium text-purple-700 mb-1">Couleur</label>
                    <input type="color" id="originColor" value="#4CAF50" class="w-full h-10 cursor-pointer">
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="cancelOrigin" class="px-4 py-2 border border-purple-300 text-purple-700 rounded-lg hover:bg-purple-50">Annuler</button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <div id="loanModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-purple-800">Nouveau Prêt</h3>
                <button id="closeLoanModal" class="text-purple-600 hover:text-purple-800">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="loanForm" class="space-y-4">
                <input type="hidden" id="loanId">
                <div>
                    <label for="loanName" class="block text-sm font-medium text-purple-700 mb-1">Nom du Prêt</label>
                    <input type="text" id="loanName" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                </div>
                <div>
                    <label for="loanAmount" class="block text-sm font-medium text-purple-700 mb-1">Montant Total du Prêt (€)</label>
                    <input type="number" step="0.01" id="loanAmount" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                </div>
                <div>
                    <label for="loanPaid" class="block text-sm font-medium text-purple-700 mb-1">Montant Déjà Remboursé (€)</label>
                    <input type="number" step="0.01" id="loanPaid" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" value="0">
                </div>
                <div>
                    <label for="loanDueDate" class="block text-sm font-medium text-purple-700 mb-1">Date d'échéance</label>
                    <input type="date" id="loanDueDate" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="cancelLoan" class="px-4 py-2 border border-purple-300 text-purple-700 rounded-lg hover:bg-purple-50">Annuler</button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <div id="savingsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-purple-800">Mon Épargne</h3>
                <button id="closeSavingsModal" class="text-purple-600 hover:text-purple-800">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <p class="text-sm text-purple-600">Solde actuel de l'épargne:</p>
                <p id="savingsCurrentBalance" class="text-2xl font-bold text-purple-800">€0.00</p>
            </div>
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3 mb-4">
                <button id="depositToSavingsBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition flex-1">
                    <i class="fas fa-plus mr-2"></i> Déposer
                </button>
                <button id="withdrawFromSavingsBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition flex-1">
                    <i class="fas fa-minus mr-2"></i> Retirer
                </button>
            </div>

            <h4 class="text-lg font-semibold text-purple-800 mb-2">Historique des Transactions</h4>
            <div id="savingsTransactionsContainer" class="space-y-2 max-h-48 overflow-y-auto">
                </div>
        </div>
    </div>

    <div id="depositSavingsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-purple-800">Déposer dans l'épargne</h3>
                <button id="closeDepositSavingsModal" class="text-purple-600 hover:text-purple-800">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="depositSavingsForm" class="space-y-4">
                <div>
                    <label for="depositAmount" class="block text-sm font-medium text-purple-700 mb-1">Montant à déposer (€)</label>
                    <input type="number" step="0.01" id="depositAmount" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="cancelDeposit" class="px-4 py-2 border border-purple-300 text-purple-700 rounded-lg hover:bg-purple-50">Annuler</button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Déposer</button>
                </div>
            </form>
        </div>
    </div>

    <div id="withdrawSavingsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-purple-800">Retirer de l'épargne</h3>
                <button id="closeWithdrawSavingsModal" class="text-purple-600 hover:text-purple-800">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="withdrawSavingsForm" class="space-y-4">
                <div>
                    <label for="withdrawAmount" class="block text-sm font-medium text-purple-700 mb-1">Montant à retirer (€)</label>
                    <input type="number" step="0.01" id="withdrawAmount" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                </div>
                <div>
                    <label for="withdrawDescription" class="block text-sm font-medium text-purple-700 mb-1">Description</label>
                    <input type="text" id="withdrawDescription" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="cancelWithdraw" class="px-4 py-2 border border-purple-300 text-purple-700 rounded-lg hover:bg-purple-50">Annuler</button>
                    <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Retirer</button>
                </div>
            </form>
        </div>
    </div>

    <div id="salaryForecastModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-purple-800">Nouvelle Prévision Salariale</h3>
                <button id="closeSalaryForecastModal" class="text-purple-600 hover:text-purple-800">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="salaryForecastForm" class="space-y-4">
                <input type="hidden" id="salaryForecastId">
                <div>
                    <label for="salaryForecastName" class="block text-sm font-medium text-purple-700 mb-1">Nom de la Prévision</label>
                    <input type="text" id="salaryForecastName" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-purple-700 mb-1">Dépenses Fixes</label>
                    <div id="salaryForecastExpensesContainer" class="space-y-2 mb-2">
                        </div>
                    <button type="button" id="addSalaryForecastExpenseItem" class="text-sm text-purple-600 hover:text-purple-800 flex items-center">
                        <i class="fas fa-plus mr-1"></i> Ajouter une dépense fixe
                    </button>
                </div>
                <div class="mt-4 p-3 bg-purple-50 rounded-lg">
                    <p class="text-sm font-medium text-purple-700">Total Dépenses Fixes: <span id="salaryForecastTotalExpenses" class="font-bold text-purple-800">€0.00</span></p>
                </div>
                <div class="mt-4">
                    <label for="salaryForecastAverageSalary" class="block text-sm font-medium text-purple-700 mb-1">Salaire Moyen (€)</label>
                    <input type="number" step="0.01" id="salaryForecastAverageSalary" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                </div>
                <div class="mt-4 p-3 bg-purple-100 rounded-lg">
                    <p class="text-sm font-medium text-purple-700">Reste après dépenses: <span id="salaryForecastRemainingSalary" class="font-bold text-purple-800">€0.00</span></p>
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="cancelSalaryForecast" class="px-4 py-2 border border-purple-300 text-purple-700 rounded-lg hover:bg-purple-50">Annuler</button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <div id="plannedExpenseModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-purple-800">Nouvelle Dépense Planifiée</h3>
                <button id="closePlannedExpenseModal" class="text-purple-600 hover:text-purple-800">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="plannedExpenseForm" class="space-y-4">
                <input type="hidden" id="plannedExpenseId">
                <div>
                    <label for="plannedExpenseName" class="block text-sm font-medium text-purple-700 mb-1">Nom de la Dépense Planifiée</label>
                    <input type="text" id="plannedExpenseName" class="w-full px-4 py-2 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-purple-700 mb-1">Éléments de Dépense</label>
                    <div id="plannedExpenseItemsContainer" class="space-y-2 mb-2">
                        </div>
                    <button type="button" id="addPlannedExpenseItem" class="text-sm text-purple-600 hover:text-purple-800 flex items-center">
                        <i class="fas fa-plus mr-1"></i> Ajouter un élément
                    </button>
                </div>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="cancelPlannedExpense" class="px-4 py-2 border border-purple-300 text-purple-700 rounded-lg hover:bg-purple-50">Annuler</button>
                    <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">Enregistrer</button>
                </div>
            </form>
        </div>
    </div>

    <div id="confirmModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-xl p-6 w-full max-w-md">
            <div class="text-center">
                <i class="fas fa-exclamation-circle text-4xl text-purple-600 mb-4"></i>
                <h3 id="confirmMessage" class="text-xl font-bold text-purple-800 mb-4">Êtes-vous sûr de vouloir supprimer cet élément ?</h3>
                <div class="flex justify-center space-x-4">
                    <button id="confirmCancel" class="px-4 py-2 border border-purple-300 text-purple-700 rounded-lg hover:bg-purple-50">Annuler</button>
                    <button id="confirmDelete" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Supprimer</button>
                </div>
            </div>
        </div>
    </div>

    <div id="messageModal" class="custom-modal-backdrop hidden">
        <div class="custom-modal">
            <h3 id="messageModalTitle" class="text-xl font-bold text-purple-800 mb-4"></h3>
            <p id="messageModalContent" class="text-gray-700 mb-6"></p>
            <button id="closeMessageModal" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">OK</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0/dist/chartjs-adapter-moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Structure de données initiale (valeurs par défaut si localStorage est vide)
        const defaultCategories = [
            { id: 'work', name: 'Travail', color: '#9333ea' },
            { id: 'personal', name: 'Personnel', color: '#3b82f6' },
            { id: 'health', name: 'Santé', color: '#10b981' },
            { id: 'finance', name: 'Finances', color: '#f59e0b' },
            { id: 'food', name: 'Nourriture', color: '#65a30d' },
            { id: 'transport', name: 'Transport', color: '#0ea5e9' },
            { id: 'housing', name: 'Logement', color: '#7c3aed' },
            { id: 'entertainment', name: 'Loisirs', color: '#f97316' },
            { id: 'other', name: 'Autre', color: '#64748b' }
        ];
        const defaultOrigins = [
            { id: 'salary', name: 'Salaire', color: '#4CAF50' },
            { id: 'gift', name: 'Don', color: '#FFC107' },
            { id: 'freelance', name: 'Freelance', color: '#2196F3' },
            { id: 'savings-transfer', name: 'Transfert Épargne', color: '#9C27B0' },
            { id: 'loan-disbursement', name: 'Décaissement Prêt', color: '#FF5722' },
            { id: 'other-income', name: 'Autre Revenu', color: '#607D8B' },
            { id: 'cash', name: 'Espèces', color: '#78716c' },
            { id: 'bank-card', name: 'Carte Bancaire', color: '#4c1d95' },
            { id: 'online-payment', name: 'Paiement en ligne', color: '#6d28d9' },
            { id: 'loan-repayment', name: 'Remboursement Prêt', color: '#FF0000' } // Added for loan repayments
        ];

        let appData = {
            todos: [],
            notes: [],
            lists: [],
            expenses: [],
            wellness: [],
            categories: defaultCategories,
            origins: defaultOrigins,
            loans: [],
            savings: { balance: 0, transactions: [] },
            salaryForecasts: [],
            plannedExpenses: []
        };

        // Variables de configuration GitHub
        let githubUsername = '';
        let githubRepo = '';
        let githubToken = '';
        let githubFileSha = undefined; // Initialisé à undefined pour indiquer qu'aucun SHA n'est connu

        const GITHUB_DATA_FILE = 'appData.json'; // Nom du fichier JSON sur GitHub

        // Éléments du DOM
        const sectionBtns = document.querySelectorAll('.section-btn');
        const sectionContents = document.querySelectorAll('.section-content');
        const todoFilterBtns = document.querySelectorAll('.todo-filter-btn');
        const expenseFilterBtns = document.querySelectorAll('.expense-filter-btn');

        // Modales
        const todoModal = document.getElementById('todoModal');
        const noteModal = document.getElementById('noteModal');
        const listModal = document.getElementById('listModal');
        const expenseModal = document.getElementById('expenseModal');
        const incomeModal = document.getElementById('incomeModal');
        const wellnessModal = document.getElementById('wellnessModal');
        const categoryModal = document.getElementById('categoryModal');
        const originModal = document.getElementById('originModal');
        const loanModal = document.getElementById('loanModal');
        const savingsModal = document.getElementById('savingsModal');
        const depositSavingsModal = document.getElementById('depositSavingsModal');
        const withdrawSavingsModal = document.getElementById('withdrawSavingsModal');
        const salaryForecastModal = document.getElementById('salaryForecastModal');
        const plannedExpenseModal = document.getElementById('plannedExpenseModal');
        const confirmModal = document.getElementById('confirmModal');
        const messageModal = document.getElementById('messageModal');

        // Formulaires
        const todoForm = document.getElementById('todoForm');
        const noteForm = document.getElementById('noteForm');
        const listForm = document.getElementById('listForm');
        const expenseForm = document.getElementById('expenseForm');
        const incomeForm = document.getElementById('incomeForm');
        const wellnessForm = document.getElementById('wellnessForm');
        const categoryForm = document.getElementById('categoryForm');
        const originForm = document.getElementById('originForm');
        const loanForm = document.getElementById('loanForm');
        const depositSavingsForm = document.getElementById('depositSavingsForm');
        const withdrawSavingsForm = document.getElementById('withdrawSavingsForm');
        const salaryForecastForm = document.getElementById('salaryForecastForm');
        const plannedExpenseForm = document.getElementById('plannedExpenseForm');

        // Conteneurs
        const todosContainer = document.getElementById('todos-container');
        const notesContainer = document.getElementById('notes-container');
        const expensesContainer = document.getElementById('expenses-container');
        const wellnessContainer = document.getElementById('wellness-container');
        const categoriesListDisplay = document.getElementById('categories-list-display');
        const originsListDisplay = document.getElementById('origins-list-display');
        const loansContainer = document.getElementById('loans-container');
        const savingsTransactionsContainer = document.getElementById('savingsTransactionsContainer');
        const salaryForecastContainer = document.getElementById('salary-forecast-container');
        const plannedExpensesContainer = document.getElementById('planned-expenses-container');

        // Éléments de graphique
        let weightChartInstance, moodChartInstance, sleepChartInstance, exerciseChartInstance, waterChartInstance, expenseCategoryChartInstance;

        // Élément courant à supprimer (pour la modale de confirmation)
        let itemToDelete = null;

        // Génère un ID unique
        function generateId() {
            return '_' + Math.random().toString(36).substr(2, 9);
        }

        // Fonction pour afficher une modale de message personnalisée
        function showMessage(title, content) {
            document.getElementById('messageModalTitle').textContent = title;
            document.getElementById('messageModalContent').textContent = content;
            messageModal.classList.remove('hidden');
        }

        // Fonction pour cacher la modale de message
        document.getElementById('closeMessageModal').addEventListener('click', () => {
            messageModal.classList.add('hidden');
        });

        // Sauvegarde les données (maintenant vers GitHub)
        async function saveData() {
            await saveDataToGitHub();
            updateStats();
            updateFinancialSummary();
            updateCharts();
            renderOverview();
        }

        // Charge les données (maintenant depuis GitHub)
        async function loadData() {
            // Tente de charger la configuration GitHub depuis localStorage
            const savedGithubConfig = localStorage.getItem('githubConfig');
            if (savedGithubConfig) {
                const config = JSON.parse(savedGithubConfig);
                githubUsername = config.username;
                githubRepo = config.repo;
                githubToken = config.token;

                document.getElementById('githubUsername').value = githubUsername;
                document.getElementById('githubRepo').value = githubRepo;
                document.getElementById('githubToken').value = githubToken;

                await loadDataFromGitHub();
            } else {
                // Si aucune configuration GitHub n'est trouvée, afficher la section de configuration
                document.getElementById('githubConfigSection').classList.remove('hidden');
                showMessage('Configuration requise', 'Veuillez configurer vos informations GitHub pour charger/sauvegarder vos données.');
            }
        }

        // Charge les données depuis GitHub
        async function loadDataFromGitHub() {
            if (!githubUsername || !githubRepo || !githubToken) {
                showMessage('Erreur', 'Veuillez configurer vos informations GitHub.');
                document.getElementById('githubConfigSection').classList.remove('hidden');
                return;
            }

            document.getElementById('githubStatus').classList.remove('hidden');
            document.getElementById('githubStatus').classList.remove('bg-red-100', 'text-red-800');
            document.getElementById('githubStatus').classList.add('bg-purple-100', 'text-purple-800');
            document.getElementById('githubStatusMessage').textContent = 'Chargement des données depuis GitHub...';

            const url = `https://api.github.com/repos/${githubUsername}/${githubRepo}/contents/${GITHUB_DATA_FILE}`;

            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json' // Changed to get JSON with SHA
                    }
                });

                if (response.status === 404) {
                    // Fichier non trouvé, initialiser avec les données par défaut et tenter de créer le fichier
                    showMessage('Initialisation', 'Fichier de données GitHub non trouvé. Création d\'un nouveau fichier...');
                    appData = {
                        todos: [], notes: [], lists: [], expenses: [], wellness: [],
                        categories: defaultCategories, origins: defaultOrigins, loans: [],
                        savings: { balance: 0, transactions: [] }, salaryForecasts: [], plannedExpenses: []
                    };
                    githubFileSha = undefined; // Explicitly set to undefined for new creation
                    await saveDataToGitHub(); // Attempt to create the file
                    document.getElementById('githubStatusMessage').textContent = 'Données initialisées et fichier créé sur GitHub.';
                } else if (!response.ok) {
                    const errorJson = await response.json(); // Parse error response
                    throw new Error(`Erreur GitHub: ${response.status} - ${errorJson.message || JSON.stringify(errorJson)}`);
                } else {
                    const data = await response.json();
                    githubFileSha = data.sha; // Store the SHA for future updates
                    const decodedContent = atob(data.content); // Decode Base64 content
                    appData = JSON.parse(decodedContent);
                    
                    // Ensure new properties are initialized if they are missing in loaded data
                    appData.todos = appData.todos || [];
                    appData.notes = appData.notes || [];
                    appData.lists = appData.lists || [];
                    appData.expenses = appData.expenses || [];
                    appData.wellness = appData.wellness || [];
                    appData.loans = appData.loans || [];
                    appData.savings = appData.savings || { balance: 0, transactions: [] };
                    appData.salaryForecasts = appData.salaryForecasts || [];
                    appData.plannedExpenses = appData.plannedExpenses || [];
                    appData.categories = appData.categories !== undefined ? appData.categories : defaultCategories;
                    appData.origins = appData.origins !== undefined ? appData.origins : defaultOrigins;

                    document.getElementById('githubStatusMessage').textContent = 'Données chargées avec succès depuis GitHub.';
                    document.getElementById('githubConfigSection').classList.add('hidden'); // Hide config if loading successful
                }

            } catch (error) {
                console.error("Erreur lors du chargement des données depuis GitHub:", error);
                document.getElementById('githubStatus').classList.remove('bg-purple-100', 'text-purple-800');
                document.getElementById('githubStatus').classList.add('bg-red-100', 'text-red-800');
                document.getElementById('githubStatusMessage').textContent = `Erreur de chargement GitHub: ${error.message}. Vérifiez votre configuration.`;
                showMessage('Erreur de chargement', `Impossible de charger les données depuis GitHub: ${error.message}. Veuillez vérifier vos informations de configuration.`);
                document.getElementById('githubConfigSection').classList.remove('hidden'); // Show config on error
            } finally {
                // Initialiser l'interface utilisateur après la tentative de chargement
                populateCategoryDropdowns();
                populateOriginDropdowns();
                renderCategoriesDisplay();
                renderOriginsDisplay();
                initCharts();
                setActiveSection('overview'); // This will trigger renderAllSections etc.
                updateStats();
                updateCharts();
                updateFinancialSummary();
            }
        }

        // Sauvegarde les données vers GitHub
        async function saveDataToGitHub() {
            if (!githubUsername || !githubRepo || !githubToken) {
                showMessage('Erreur de sauvegarde', 'La configuration GitHub est manquante. Impossible de sauvegarder.');
                document.getElementById('githubConfigSection').classList.remove('hidden');
                return;
            }

            document.getElementById('githubStatus').classList.remove('hidden');
            document.getElementById('githubStatus').classList.remove('bg-red-100', 'text-red-800');
            document.getElementById('githubStatus').classList.add('bg-purple-100', 'text-purple-800');
            document.getElementById('githubStatusMessage').textContent = 'Sauvegarde des données vers GitHub...';

            const url = `https://api.github.com/repos/${githubUsername}/${githubRepo}/contents/${GITHUB_DATA_FILE}`;
            const content = btoa(JSON.stringify(appData, null, 2)); // Encoder en Base64

            let currentSha = undefined; // Start with undefined, will try to fetch

            // Always attempt to get the current SHA of the file
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                if (response.ok) {
                    const fileData = await response.json();
                    currentSha = fileData.sha;
                } else if (response.status === 404) {
                    // File does not exist, so it's a creation. No SHA needed.
                    currentSha = undefined;
                } else {
                    const errorJson = await response.json();
                    throw new Error(`Erreur lors de la récupération du SHA: ${response.status} - ${errorJson.message || JSON.stringify(errorJson)}`);
                }
            } catch (error) {
                console.error("Erreur lors de la récupération du SHA:", error);
                document.getElementById('githubStatus').classList.remove('bg-purple-100', 'text-purple-800');
                document.getElementById('githubStatus').classList.add('bg-red-100', 'text-red-800');
                document.getElementById('githubStatusMessage').textContent = `Erreur lors de la récupération du SHA: ${error.message}`;
                showMessage('Erreur de sauvegarde', `Impossible de récupérer le SHA du fichier: ${error.message}.`);
                return;
            }

            const commitMessage = currentSha ? `Mise à jour des données personnelles (${new Date().toLocaleString()})` : `Création de ${GITHUB_DATA_FILE}`;

            const payload = {
                message: commitMessage,
                content: content,
                branch: 'main' // Ensure the branch is specified, 'main' is common
            };

            // Only add SHA if it exists (i.e., it's an update)
            if (currentSha) {
                payload.sha = currentSha;
            }


            try {
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${githubToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorJson = await response.json();
                    throw new Error(`Erreur GitHub: ${response.status} - ${errorJson.message || JSON.stringify(errorJson)}`);
                }

                const result = await response.json();
                githubFileSha = result.content.sha; // Update SHA after successful save
                document.getElementById('githubStatusMessage').textContent = 'Données sauvegardées avec succès sur GitHub.';
            } catch (error) {
                console.error("Erreur lors de la sauvegarde des données sur GitHub:", error);
                document.getElementById('githubStatus').classList.remove('bg-purple-100', 'text-purple-800');
                document.getElementById('githubStatus').classList.add('bg-red-100', 'text-red-800');
                document.getElementById('githubStatusMessage').textContent = `Erreur de sauvegarde GitHub: ${error.message}`;
                showMessage('Erreur de sauvegarde', `Impossible de sauvegarder les données sur GitHub: ${error.message}.`);
            }
        }

        // Initialisation de l'application
        document.addEventListener('DOMContentLoaded', async () => {
            // Ne pas appeler loadData() ici directement car nous voulons d'abord vérifier la config GitHub
            // Les appels à renderAllSections, updateStats, etc. se feront après le chargement/initialisation via GitHub
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('todoDueDate').value = today;
            document.getElementById('expenseDate').value = today;
            document.getElementById('incomeDate').value = today;
            document.getElementById('wellnessDate').value = today;

            // Charger la configuration GitHub et tenter de charger les données
            await loadData();
        });

        // Gestion de la configuration GitHub
        document.getElementById('saveGithubConfigBtn').addEventListener('click', async () => {
            githubUsername = document.getElementById('githubUsername').value.trim();
            githubRepo = document.getElementById('githubRepo').value.trim();
            githubToken = document.getElementById('githubToken').value.trim();

            if (!githubUsername || !githubRepo || !githubToken) {
                showMessage('Erreur', 'Tous les champs de configuration GitHub sont requis.');
                return;
            }

            localStorage.setItem('githubConfig', JSON.stringify({
                username: githubUsername,
                repo: githubRepo,
                token: githubToken
            }));
            showMessage('Configuration enregistrée', 'Vos informations GitHub ont été enregistrées. Tentative de chargement des données...');
            await loadDataFromGitHub(); // Tenter de charger les données avec la nouvelle config
        });


        // Rend toutes les sections
        function renderAllSections() {
            renderOverview();
            renderTodos();
            renderNotes();
            renderExpenses();
            renderWellness();
            renderLoans();
            renderSalaryForecasts();
            renderPlannedExpenses();
        }

        // Navigation entre les sections
        sectionBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const section = btn.dataset.section;
                setActiveSection(section);
            });
        });

        function setActiveSection(section) {
            sectionBtns.forEach(btn => {
                if (btn.dataset.section === section) {
                    btn.classList.remove('hover:bg-purple-50', 'text-purple-700');
                    btn.classList.add('bg-purple-100', 'text-purple-800');
                } else {
                    btn.classList.add('hover:bg-purple-50', 'text-purple-700');
                    btn.classList.remove('bg-purple-100', 'text-white'); // Fix: remove bg-purple-600, text-white
                }
            });

            sectionContents.forEach(content => {
                if (content.id === `${section}-section`) {
                    content.classList.remove('hidden');
                    content.classList.add('fade-in');
                } else {
                    content.classList.add('hidden');
                    content.classList.remove('fade-in');
                }
            });

            switch (section) {
                case 'overview': renderOverview(); break;
                case 'todos': renderTodos(); break;
                case 'notes': renderNotes(); break;
                case 'expenses': renderExpenses(); renderLoans(); break;
                case 'wellness': renderWellness(); updateCharts(); break;
                case 'salary-forecast': renderSalaryForecasts(); break;
                case 'planned-expenses': renderPlannedExpenses(); break;
            }
        }

        // Boutons de filtre des tâches
        todoFilterBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                todoFilterBtns.forEach(b => {
                    if (b === btn) {
                        b.classList.remove('bg-purple-100', 'text-purple-800');
                        b.classList.add('bg-purple-600', 'text-white');
                    } else {
                        b.classList.add('bg-purple-100', 'text-purple-800');
                        b.classList.remove('bg-purple-600', 'text-white');
                    }
                });
                renderTodos(btn.dataset.filter);
            });
        });

        // Boutons de filtre des dépenses
        expenseFilterBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                expenseFilterBtns.forEach(b => {
                    if (b === btn) {
                        b.classList.remove('bg-purple-100', 'text-purple-800');
                        b.classList.add('bg-purple-600', 'text-white');
                    } else {
                        b.classList.add('bg-purple-100', 'text-purple-800');
                        b.classList.remove('bg-purple-600', 'text-white');
                    }
                });
                renderExpenses(btn.dataset.filter);
            });
        });

        // Gestion des modales (ouverture/fermeture)
        document.getElementById('addTodoBtn').addEventListener('click', () => { resetTodoForm(); todoModal.classList.remove('hidden'); });
        document.getElementById('addNoteBtn').addEventListener('click', () => { resetNoteForm(); noteModal.classList.remove('hidden'); });
        document.getElementById('addListBtn').addEventListener('click', () => { resetListForm(); listModal.classList.remove('hidden'); });
        document.getElementById('addExpenseBtn').addEventListener('click', () => { resetExpenseForm(); expenseModal.classList.remove('hidden'); });
        document.getElementById('addIncomeBtn').addEventListener('click', () => { resetIncomeForm(); incomeModal.classList.remove('hidden'); });
        document.getElementById('addWellnessBtn').addEventListener('click', () => { resetWellnessForm(); updateWellnessFormFields(); wellnessModal.classList.remove('hidden'); });
        document.getElementById('addCategoryBtn').addEventListener('click', () => { resetCategoryForm(); categoryModal.classList.remove('hidden'); });
        document.getElementById('addOriginBtn').addEventListener('click', () => { resetOriginForm(); originModal.classList.remove('hidden'); });
        document.getElementById('addLoanBtn').addEventListener('click', () => { resetLoanForm(); loanModal.classList.remove('hidden'); });
        document.getElementById('overviewCurrentBalanceCard').addEventListener('click', () => { /* Peut-être ouvrir une modale d'historique de solde détaillé ici */ });
        document.getElementById('currentBalanceCard').addEventListener('click', () => { /* Peut-être ouvrir une modale d'historique de solde détaillé ici */ });
        document.getElementById('overviewSavingsBalanceCard').addEventListener('click', () => { renderSavingsModal(); savingsModal.classList.remove('hidden'); });
        document.getElementById('totalSavingsCard').addEventListener('click', () => { renderSavingsModal(); savingsModal.classList.remove('hidden'); });
        document.getElementById('depositToSavingsBtn').addEventListener('click', () => { depositSavingsModal.classList.remove('hidden'); });
        document.getElementById('withdrawFromSavingsBtn').addEventListener('click', () => { withdrawSavingsModal.classList.remove('hidden'); });
        document.getElementById('addSalaryForecastBtn').addEventListener('click', () => { resetSalaryForecastForm(); salaryForecastModal.classList.remove('hidden'); });
        document.getElementById('addPlannedExpenseBtn').addEventListener('click', () => { resetPlannedExpenseForm(); plannedExpenseModal.classList.remove('hidden'); });


        // Ajout des écouteurs d'événements pour les boutons de fermeture et d'annulation
        document.querySelectorAll('.fixed.inset-0 button[id^="close"], .fixed.inset-0 button[id^="cancel"]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.target.closest('.fixed.inset-0').classList.add('hidden');
            });
        });

        // Fonctions de réinitialisation des formulaires
        function resetTodoForm() {
            todoForm.reset();
            document.getElementById('todoId').value = '';
            document.getElementById('todoDueDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('todoPriority').value = 'medium';
            populateCategoryDropdowns();
            document.getElementById('todoCategory').value = appData.categories[0] ? appData.categories[0].id : '';
        }
        function resetNoteForm() {
            noteForm.reset();
            document.getElementById('noteId').value = '';
            document.getElementById('noteColor').value = 'bg-purple-100';
        }
        function resetListForm() {
            listForm.reset();
            document.getElementById('listId').value = '';
            document.getElementById('listColor').value = 'bg-purple-100';
            document.getElementById('listItemsContainer').innerHTML = ''; // Vider les éléments de liste
        }
        function resetExpenseForm() {
            expenseForm.reset();
            document.getElementById('expenseId').value = '';
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            populateCategoryDropdowns();
            populateOriginDropdowns();
            document.getElementById('expenseCategory').value = appData.categories.find(c => c.id === 'other') ? 'other' : appData.categories[0]?.id || '';
            document.getElementById('expenseOrigin').value = appData.origins.find(o => o.id === 'cash') ? 'cash' : appData.origins[0]?.id || '';
        }
        function resetIncomeForm() {
            incomeForm.reset();
            document.getElementById('incomeDate').value = new Date().toISOString().split('T')[0];
            populateOriginDropdowns();
            document.getElementById('incomeOrigin').value = appData.origins.find(o => o.id === 'salary') ? 'salary' : appData.origins[0]?.id || '';
        }
        function resetWellnessForm() {
            wellnessForm.reset();
            document.getElementById('wellnessId').value = '';
            document.getElementById('wellnessDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('wellnessType').value = 'weight';
            document.getElementById('wellnessMood').value = '';
            document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('bg-purple-100'));
        }
        function resetCategoryForm() {
            categoryForm.reset();
            document.getElementById('categoryId').value = '';
            document.getElementById('categoryColor').value = '#9333ea';
        }
        function resetOriginForm() {
            originForm.reset();
            document.getElementById('originId').value = '';
            document.getElementById('originColor').value = '#4CAF50';
        }
        function resetLoanForm() {
            loanForm.reset();
            document.getElementById('loanId').value = '';
            document.getElementById('loanPaid').value = '0';
            document.getElementById('loanDueDate').value = '';
        }
        function resetDepositSavingsForm() {
            depositSavingsForm.reset();
            document.getElementById('depositAmount').value = '';
        }
        function resetWithdrawSavingsForm() {
            withdrawSavingsForm.reset();
            document.getElementById('withdrawAmount').value = '';
            document.getElementById('withdrawDescription').value = '';
        }
        function resetSalaryForecastForm() {
            salaryForecastForm.reset();
            document.getElementById('salaryForecastId').value = '';
            document.getElementById('salaryForecastExpensesContainer').innerHTML = '';
            updateSalaryForecastTotals(); // Reset totals display
        }
        function resetPlannedExpenseForm() {
            plannedExpenseForm.reset();
            document.getElementById('plannedExpenseId').value = '';
            document.getElementById('plannedExpenseItemsContainer').innerHTML = '';
        }

        // Soumissions de formulaires
        todoForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('todoId').value || generateId();
            const title = document.getElementById('todoTitle').value.trim();
            const description = document.getElementById('todoDescription').value.trim();
            const dueDate = document.getElementById('todoDueDate').value;
            const priority = document.getElementById('todoPriority').value;
            const category = document.getElementById('todoCategory').value;

            if (!title) { showMessage('Erreur', 'Le titre de la tâche est requis.'); return; }

            if (appData.todos.some(todo => todo.id === id)) {
                appData.todos = appData.todos.map(todo =>
                    todo.id === id ? { ...todo, title, description, dueDate, priority, category } : todo
                );
            } else {
                const newTodo = { id, title, description, dueDate, priority, category, completed: false, createdAt: new Date().toISOString() };
                appData.todos.push(newTodo);
            }
            await saveData();
            renderTodos();
            todoModal.classList.add('hidden');
        });

        noteForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('noteId').value || generateId();
            const title = document.getElementById('noteTitle').value.trim();
            const content = document.getElementById('noteContent').value.trim();
            const color = document.getElementById('noteColor').value;

            if (!title && !content) { showMessage('Erreur', 'Veuillez entrer un titre ou un contenu pour la note.'); return; }

            if (appData.notes.some(note => note.id === id)) {
                appData.notes = appData.notes.map(note =>
                    note.id === id ? { ...note, title, content, color } : note
                );
            } else {
                const newNote = { id, title, content, color, createdAt: new Date().toISOString() };
                appData.notes.push(newNote);
            }
            await saveData();
            renderNotes();
            noteModal.classList.add('hidden');
        });

        listForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('listId').value || generateId();
            const title = document.getElementById('listTitle').value.trim();
            const color = document.getElementById('listColor').value;
            
            const items = [];
            document.querySelectorAll('#listItemsContainer .list-item-input').forEach(el => {
                if (el.value.trim()) {
                    items.push({ text: el.value.trim(), completed: el.previousElementSibling.checked });
                }
            });

            if (!title) { showMessage('Erreur', 'Le titre de la liste est requis.'); return; }

            if (appData.lists.some(list => list.id === id)) {
                appData.lists = appData.lists.map(list =>
                    list.id === id ? { ...list, title, color, items } : list
                );
            } else {
                const newList = { id, title, color, items, createdAt: new Date().toISOString() };
                appData.lists.push(newList);
            }
            await saveData();
            renderNotes();
            listModal.classList.add('hidden');
        });

        expenseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('expenseId').value || generateId();
            const date = document.getElementById('expenseDate').value;
            const description = document.getElementById('expenseDescription').value.trim();
            const category = document.getElementById('expenseCategory').value;
            const origin = document.getElementById('expenseOrigin').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value);

            if (!description || isNaN(amount) || amount === 0) { showMessage('Erreur', 'Veuillez entrer une description et un montant valide.'); return; }
            if (amount > 0) { showMessage('Erreur', 'Veuillez utiliser la section "Ajouter Revenu" pour les montants positifs.'); return; }

            if (appData.expenses.some(expense => expense.id === id)) {
                appData.expenses = appData.expenses.map(expense =>
                    expense.id === id ? { ...expense, date, description, category, origin, amount } : expense
                );
            } else {
                const newExpense = { id, date, description, category, origin, amount: -Math.abs(amount), createdAt: new Date().toISOString() };
                appData.expenses.push(newExpense);
            }
            await saveData();
            renderExpenses();
            expenseModal.classList.add('hidden');
        });

        incomeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const date = document.getElementById('incomeDate').value;
            const description = document.getElementById('incomeDescription').value.trim();
            const origin = document.getElementById('incomeOrigin').value;
            const amount = parseFloat(document.getElementById('incomeAmount').value);

            if (!description || isNaN(amount) || amount <= 0) { showMessage('Erreur', 'Veuillez entrer une description et un montant valide pour le revenu.'); return; }

            const newIncome = { id: generateId(), date, description, category: 'finance', origin, amount: Math.abs(amount), createdAt: new Date().toISOString() };
            appData.expenses.push(newIncome);
            await saveData();
            renderExpenses();
            incomeModal.classList.add('hidden');
        });

        wellnessForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('wellnessId').value || generateId();
            const date = document.getElementById('wellnessDate').value;
            const type = document.getElementById('wellnessType').value;
            let value;
            if (type === 'mood') {
                value = document.getElementById('wellnessMood').value;
                if (!value) { showMessage('Erreur', 'Veuillez sélectionner votre humeur.'); return; }
            } else {
                value = parseFloat(document.getElementById('wellnessValue').value);
                if (isNaN(value)) { showMessage('Erreur', 'Veuillez entrer une valeur valide.'); return; }
            }
            const notes = document.getElementById('wellnessNotes').value.trim();

            if (appData.wellness.some(entry => entry.id === id)) {
                appData.wellness = appData.wellness.map(entry =>
                    entry.id === id ? { ...entry, date, type, value, notes } : entry
                );
            } else {
                const newWellness = { id, date, type, value, notes, createdAt: new Date().toISOString() };
                appData.wellness.push(newWellness);
            }
            await saveData();
            renderWellness();
            updateCharts();
            wellnessModal.classList.add('hidden');
        });

        categoryForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('categoryId').value; // Use existing ID for edit, or empty for new
            const name = document.getElementById('categoryName').value.trim();
            const color = document.getElementById('categoryColor').value;

            if (!name) { showMessage('Erreur', 'Le nom de la catégorie est requis.'); return; }

            const newCategoryId = name.toLowerCase().replace(/\s+/g, '-');
            
            // Check if ID is being changed to an existing one (only for edits)
            if (id && id !== newCategoryId && appData.categories.some(cat => cat.id === newCategoryId)) {
                showMessage('Erreur', 'Une catégorie avec ce nom existe déjà.');
                return;
            }
            // Check for existing ID for new categories
            if (!id && appData.categories.some(cat => cat.id === newCategoryId)) {
                showMessage('Erreur', 'Cette catégorie existe déjà.');
                return;
            }

            if (id && appData.categories.some(cat => cat.id === id)) {
                // Edit existing category
                appData.categories = appData.categories.map(cat => 
                    cat.id === id ? { ...cat, id: newCategoryId, name, color } : cat
                );
                // Update existing items with new category ID if ID changed
                if (id !== newCategoryId) {
                    appData.todos.forEach(todo => { if (todo.category === id) todo.category = newCategoryId; });
                    appData.expenses.forEach(expense => { if (expense.category === id) expense.category = newCategoryId; });
                }
            } else {
                // Add new category
                const newCategory = { id: newCategoryId, name, color };
                appData.categories.push(newCategory);
            }

            await saveData();
            populateCategoryDropdowns();
            renderCategoriesDisplay();
            categoryModal.classList.add('hidden');
            renderAllSections();
        });

        originForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('originId').value;
            const name = document.getElementById('originName').value.trim();
            const color = document.getElementById('originColor').value;

            if (!name) { showMessage('Erreur', 'Le nom de la provenance est requis.'); return; }

            const newOriginId = name.toLowerCase().replace(/\s+/g, '-');
            if (id && id !== newOriginId && appData.origins.some(org => org.id === newOriginId)) {
                showMessage('Erreur', 'Une provenance avec ce nom existe déjà.');
                return;
            }
            if (!id && appData.origins.some(org => org.id === newOriginId)) {
                showMessage('Erreur', 'Cette provenance existe déjà.');
                return;
            }

            if (id && appData.origins.some(org => org.id === id)) {
                appData.origins = appData.origins.map(org => 
                    org.id === id ? { ...org, id: newOriginId, name, color } : org
                );
                if (id !== newOriginId) {
                    appData.expenses.forEach(expense => { if (expense.origin === id) expense.origin = newOriginId; });
                }
            } else {
                const newOrigin = { id: newOriginId, name, color };
                appData.origins.push(newOrigin);
            }

            await saveData();
            populateOriginDropdowns();
            renderOriginsDisplay();
            originModal.classList.add('hidden');
            renderAllSections();
        });

        loanForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('loanId').value || generateId();
            const name = document.getElementById('loanName').value.trim();
            const amount = parseFloat(document.getElementById('loanAmount').value);
            const paid = parseFloat(document.getElementById('loanPaid').value);
            const dueDate = document.getElementById('loanDueDate').value;

            if (!name || isNaN(amount) || amount <= 0) { showMessage('Erreur', 'Veuillez entrer un nom et un montant total valide pour le prêt.'); return; }
            if (isNaN(paid) || paid < 0) { showMessage('Erreur', 'Veuillez entrer un montant remboursé valide.'); return; }
            if (paid > amount) { showMessage('Erreur', 'Le montant remboursé ne peut pas être supérieur au montant total du prêt.'); return; }

            if (appData.loans.some(loan => loan.id === id)) {
                appData.loans = appData.loans.map(loan =>
                    loan.id === id ? { ...loan, name, amount, paid, dueDate } : loan
                );
            } else {
                const newLoan = { id, name, amount, paid, dueDate, createdAt: new Date().toISOString() };
                appData.loans.push(newLoan);
            }
            await saveData();
            renderLoans();
            loanModal.classList.add('hidden');
        });

        depositSavingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('depositAmount').value);

            if (isNaN(amount) || amount <= 0) { showMessage('Erreur', 'Veuillez entrer un montant valide à déposer.'); return; }

            appData.savings.balance += amount;
            appData.savings.transactions.push({ id: generateId(), date: new Date().toISOString().split('T')[0], type: 'deposit', amount: amount });
            
            const transferExpense = {
                id: generateId(),
                date: new Date().toISOString().split('T')[0],
                description: `Dépôt vers épargne`,
                category: 'finance',
                origin: 'savings-transfer',
                amount: -amount,
                createdAt: new Date().toISOString()
            };
            appData.expenses.push(transferExpense);

            await saveData();
            renderSavingsModal();
            depositSavingsModal.classList.add('hidden');
            renderExpenses();
        });

        withdrawSavingsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const amount = parseFloat(document.getElementById('withdrawAmount').value);
            const description = document.getElementById('withdrawDescription').value.trim();

            if (isNaN(amount) || amount <= 0) { showMessage('Erreur', 'Veuillez entrer un montant valide à retirer.'); return; }
            if (amount > appData.savings.balance) { showMessage('Erreur', 'Le montant à retirer est supérieur à votre solde d\'épargne.'); return; }
            if (!description) { showMessage('Erreur', 'Veuillez décrire la raison du retrait.'); return; }

            appData.savings.balance -= amount;
            appData.savings.transactions.push({ id: generateId(), date: new Date().toISOString().split('T')[0], type: 'withdraw', amount: amount, description: description });

            const transferIncome = {
                id: generateId(),
                date: new Date().toISOString().split('T')[0],
                description: `Retrait de l'épargne: ${description}`,
                category: 'finance',
                origin: 'savings-transfer',
                amount: amount,
                createdAt: new Date().toISOString()
            };
            appData.expenses.push(transferIncome);

            await saveData();
            renderSavingsModal();
            withdrawSavingsModal.classList.add('hidden');
            renderExpenses();
        });

        salaryForecastForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('salaryForecastId').value || generateId();
            const name = document.getElementById('salaryForecastName').value.trim();
            const averageSalary = parseFloat(document.getElementById('salaryForecastAverageSalary').value);

            if (!name || isNaN(averageSalary) || averageSalary < 0) { showMessage('Erreur', 'Veuillez entrer un nom et un salaire moyen valide.'); return; }

            const expenses = [];
            document.querySelectorAll('#salaryForecastExpensesContainer .salary-forecast-expense-item').forEach(div => {
                const desc = div.querySelector('.expense-description-input').value.trim();
                const amt = parseFloat(div.querySelector('.expense-amount-input').value);
                if (desc && !isNaN(amt) && amt > 0) {
                    expenses.push({ description: desc, amount: amt });
                }
            });

            if (appData.salaryForecasts.some(forecast => forecast.id === id)) {
                appData.salaryForecasts = appData.salaryForecasts.map(forecast =>
                    forecast.id === id ? { ...forecast, name, averageSalary, expenses } : forecast
                );
            } else {
                const newForecast = { id, name, averageSalary, expenses, createdAt: new Date().toISOString() };
                appData.salaryForecasts.push(newForecast);
            }
            await saveData();
            renderSalaryForecasts();
            salaryForecastModal.classList.add('hidden');
        });

        plannedExpenseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('plannedExpenseId').value || generateId();
            const name = document.getElementById('plannedExpenseName').value.trim();

            if (!name) { showMessage('Erreur', 'Veuillez entrer un nom pour la dépense planifiée.'); return; }

            const items = [];
            document.querySelectorAll('#plannedExpenseItemsContainer .planned-expense-item').forEach(div => {
                const desc = div.querySelector('.item-description-input').value.trim();
                const amt = parseFloat(div.querySelector('.item-amount-input').value);
                const paid = div.querySelector('.item-paid-checkbox').checked;
                if (desc && !isNaN(amt) && amt > 0) {
                    items.push({ description: desc, amount: amt, paid: paid });
                }
            });

            if (appData.plannedExpenses.some(pe => pe.id === id)) {
                appData.plannedExpenses = appData.plannedExpenses.map(pe =>
                    pe.id === id ? { ...pe, name, items } : pe
                );
            } else {
                const newPlannedExpense = { id, name, items, createdAt: new Date().toISOString() };
                appData.plannedExpenses.push(newPlannedExpense);
            }
            await saveData();
            renderPlannedExpenses();
            plannedExpenseModal.classList.add('hidden');
        });


        // Ajout d'un élément de liste (pour listes de notes et listes personnalisées)
        function addListItemToContainer(containerId, initialValue = '', isCompleted = false) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-2';
            div.innerHTML = `
                <input type="checkbox" class="list-item-checkbox" ${isCompleted ? 'checked' : ''}>
                <input type="text" class="list-item-input flex-1 px-3 py-1 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" value="${initialValue}">
                <button type="button" class="remove-list-item text-red-500 hover:text-red-700">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(div);
            
            div.querySelector('.remove-list-item').addEventListener('click', () => {
                container.removeChild(div);
            });
        }
        document.getElementById('addListItem').addEventListener('click', () => addListItemToContainer('listItemsContainer'));

        // Ajout d'un élément de dépense fixe pour la prévision salariale
        function addSalaryForecastExpenseItemToContainer(containerId, description = '', amount = '') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-2 salary-forecast-expense-item';
            div.innerHTML = `
                <input type="text" class="expense-description-input flex-1 px-3 py-1 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="Description" value="${description}">
                <input type="number" step="0.01" class="expense-amount-input w-24 px-3 py-1 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="Montant" value="${amount}">
                <button type="button" class="remove-salary-forecast-expense-item text-red-500 hover:text-red-700">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(div);
            
            const removeBtn = div.querySelector('.remove-salary-forecast-expense-item');
            removeBtn.addEventListener('click', () => {
                container.removeChild(div);
                updateSalaryForecastTotals(); // Update totals when an item is removed
            });

            const inputs = div.querySelectorAll('input');
            inputs.forEach(input => {
                input.addEventListener('input', updateSalaryForecastTotals); // Update totals on input change
            });
        }
        document.getElementById('addSalaryForecastExpenseItem').addEventListener('click', () => addSalaryForecastExpenseItemToContainer('salaryForecastExpensesContainer'));

        // Fonction pour mettre à jour les totaux dans la modale de prévision salariale
        function updateSalaryForecastTotals() {
            let totalExpenses = 0;
            document.querySelectorAll('#salaryForecastExpensesContainer .salary-forecast-expense-item').forEach(div => {
                const amt = parseFloat(div.querySelector('.expense-amount-input').value);
                if (!isNaN(amt) && amt > 0) {
                    totalExpenses += amt;
                }
            });
            document.getElementById('salaryForecastTotalExpenses').textContent = `€${totalExpenses.toFixed(2)}`;

            const averageSalary = parseFloat(document.getElementById('salaryForecastAverageSalary').value) || 0;
            const remainingSalary = averageSalary - totalExpenses;
            document.getElementById('salaryForecastRemainingSalary').textContent = `€${remainingSalary.toFixed(2)}`;
            document.getElementById('salaryForecastRemainingSalary').classList.toggle('text-red-600', remainingSalary < 0);
            document.getElementById('salaryForecastRemainingSalary').classList.toggle('text-green-600', remainingSalary >= 0);
        }
        // Add event listeners to salaryForecastAverageSalary input for live updates
        document.getElementById('salaryForecastAverageSalary').addEventListener('input', updateSalaryForecastTotals);


        // Ajout d'un élément de dépense planifiée
        function addPlannedExpenseItemToContainer(containerId, description = '', amount = '', paid = false) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'flex items-center space-x-2 planned-expense-item';
            div.innerHTML = `
                <input type="checkbox" class="item-paid-checkbox" ${paid ? 'checked' : ''}>
                <input type="text" class="item-description-input flex-1 px-3 py-1 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="Description" value="${description}">
                <input type="number" step="0.01" class="item-amount-input w-24 px-3 py-1 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" placeholder="Montant" value="${amount}">
                <button type="button" class="remove-planned-expense-item text-red-500 hover:text-red-700">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(div);
            div.querySelector('.remove-planned-expense-item').addEventListener('click', () => {
                container.removeChild(div);
            });
        }
        document.getElementById('addPlannedExpenseItem').addEventListener('click', () => addPlannedExpenseItemToContainer('plannedExpenseItemsContainer'));


        // Mise à jour des champs du formulaire Bien-être en fonction du type sélectionné
        document.getElementById('wellnessType').addEventListener('change', updateWellnessFormFields);
        function updateWellnessFormFields() {
            const type = document.getElementById('wellnessType').value;
            const valueContainer = document.getElementById('wellnessValueContainer');
            const moodContainer = document.getElementById('wellnessMoodContainer');
            const wellnessValueInput = document.getElementById('wellnessValue');
            
            if (type === 'mood') {
                valueContainer.classList.add('hidden');
                moodContainer.classList.remove('hidden');
                wellnessValueInput.removeAttribute('required');
                document.getElementById('wellnessMood').setAttribute('required', 'true');
            } else {
                valueContainer.classList.remove('hidden');
                moodContainer.classList.add('hidden');
                wellnessValueInput.setAttribute('required', 'true');
                document.getElementById('wellnessMood').removeAttribute('required');
                
                let placeholder = '';
                let step = '0.1';
                
                if (type === 'weight') {
                    placeholder = 'kg';
                    step = '0.1';
                } else if (type === 'sleep') {
                    placeholder = 'heures';
                    step = '0.5';
                } else if (type === 'exercise') {
                    placeholder = 'minutes';
                    step = '1';
                } else if (type === 'water') {
                    placeholder = 'verres';
                    step = '0.5';
                }
                
                wellnessValueInput.placeholder = placeholder;
                wellnessValueInput.step = step;
            }
        }

        // Gestion des boutons d'humeur
        document.querySelectorAll('.mood-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.mood-btn').forEach(b => {
                    b.classList.remove('bg-purple-100');
                });
                btn.classList.add('bg-purple-100');
                document.getElementById('wellnessMood').value = btn.dataset.mood;
            });
        });

        // Fonctionnalité d'exportation/importation
        document.getElementById('exportBtn').addEventListener('click', exportData);
        document.getElementById('importBtn').addEventListener('click', () => document.getElementById('fileInput').click());
        document.getElementById('fileInput').addEventListener('change', importData);
        document.getElementById('exportPdfBtn').addEventListener('click', exportPdf);


        function exportData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `mon-espace-personnel-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        function importData(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async (e) => { // Added async here
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Directly assign imported data, ensure defaults are not re-added if explicitly removed
                    appData.todos = importedData.todos || [];
                    appData.notes = importedData.notes || [];
                    appData.lists = importedData.lists || [];
                    appData.expenses = importedData.expenses || [];
                    appData.wellness = importedData.wellness || [];
                    appData.loans = importedData.loans || [];
                    appData.savings = importedData.savings || { balance: 0, transactions: [] };
                    appData.salaryForecasts = importedData.salaryForecasts || [];
                    appData.plannedExpenses = importedData.plannedExpenses || [];

                    // For categories and origins, if imported data doesn't have them, use defaults.
                    // If they exist in imported data, use them as is (allowing deletion to persist).
                    appData.categories = importedData.categories !== undefined ? importedData.categories : defaultCategories;
                    appData.origins = importedData.origins !== undefined ? importedData.origins : defaultOrigins;

                    await saveData(); // Save imported data to GitHub
                    renderAllSections();
                    populateCategoryDropdowns();
                    populateOriginDropdowns();
                    renderCategoriesDisplay();
                    renderOriginsDisplay();
                    updateStats();
                    updateCharts();
                    updateFinancialSummary();
                    
                    showMessage('Succès', 'Données importées avec succès !');
                } catch (error) {
                    showMessage('Erreur', 'Erreur lors de l\'importation du fichier : ' + error.message);
                }
            };
            reader.readAsText(file);
            
            e.target.value = '';
        }

        async function exportPdf() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'pt', 'a4'); // 'p' for portrait, 'pt' for points, 'a4' for size
            const margin = 20; // Margin from the edges
            let yPos = margin; // Initial Y position
            const pageHeight = pdf.internal.pageSize.height;
            const pageWidth = pdf.internal.pageSize.width;

            // Add a title to the PDF
            pdf.setFontSize(22);
            pdf.text('Rapport de Mon Espace Personnel', pageWidth / 2, yPos, { align: 'center' });
            yPos += 30;

            pdf.setFontSize(12);
            pdf.text(`Date du rapport: ${new Date().toLocaleDateString('fr-FR')}`, margin, yPos);
            yPos += 20;

            // Function to add a new page if content overflows
            const checkPageBreak = (heightToAdd) => {
                if (yPos + heightToAdd > pageHeight - margin) {
                    pdf.addPage();
                    yPos = margin;
                }
            };

            // --- Overview Section ---
            checkPageBreak(100);
            pdf.setFontSize(18);
            pdf.text('Vue d\'ensemble', margin, yPos);
            yPos += 25;
            pdf.setFontSize(12);
            pdf.text(`Solde Actuel: €${calculateCurrentBalance().toFixed(2)}`, margin, yPos); yPos += 15;
            pdf.text(`Épargne Totale: €${appData.savings.balance.toFixed(2)}`, margin, yPos); yPos += 15;
            pdf.text(`Prêts Restants: €${calculateTotalLoansRemaining().toFixed(2)}`, margin, yPos); yPos += 15;
            pdf.text(`Tâches Actives: ${appData.todos.filter(todo => !todo.completed).length}`, margin, yPos); yPos += 15;
            pdf.text(`Taux de Complétion Tâches: ${appData.todos.length > 0 ? ((appData.todos.filter(t => t.completed).length / appData.todos.length) * 100).toFixed(0) : 0}%`, margin, yPos); yPos += 15;
            const totalWellnessScore = appData.wellness.filter(entry => entry.type === 'mood' && entry.value).reduce((sum, entry) => sum + parseInt(entry.value), 0);
            const wellnessEntriesCount = appData.wellness.filter(entry => entry.type === 'mood' && entry.value).length;
            const wellnessIndex = wellnessEntriesCount > 0 ? (totalWellnessScore / wellnessEntriesCount).toFixed(1) : 'N/A';
            pdf.text(`Indice de Bien-être: ${wellnessIndex}`, margin, yPos); yPos += 20;

            // Add Expense Category Chart to PDF
            checkPageBreak(250); // Estimate space for chart
            pdf.setFontSize(16);
            pdf.text('Répartition des Dépenses par Catégorie', margin, yPos);
            yPos += 20;
            const expenseChartCanvas = document.getElementById('expenseCategoryChart');
            if (expenseChartCanvas) {
                const imgData = expenseChartCanvas.toDataURL('image/png');
                const imgWidth = pageWidth - 2 * margin; // Max width
                const imgHeight = (expenseChartCanvas.height * imgWidth) / expenseChartCanvas.width;
                pdf.addImage(imgData, 'PNG', margin, yPos, imgWidth, imgHeight);
                yPos += imgHeight + 20;
            }

            // --- To-do Section ---
            checkPageBreak(50);
            pdf.setFontSize(18);
            pdf.text('Mes Tâches', margin, yPos);
            yPos += 25;
            if (appData.todos.length === 0) {
                pdf.setFontSize(12);
                pdf.text('Aucune tâche enregistrée.', margin, yPos);
                yPos += 20;
            } else {
                appData.todos.forEach(todo => {
                    checkPageBreak(40);
                    const category = appData.categories.find(cat => cat.id === todo.category) || { name: todo.category, color: '#64748b' };
                    pdf.setFontSize(12);
                    pdf.text(`- ${todo.title} (Priorité: ${todo.priority}, Catégorie: ${category.name}, Échéance: ${todo.dueDate || 'N/A'}) ${todo.completed ? '[Terminée]' : ''}`, margin + 10, yPos);
                    yPos += 15;
                    if (todo.description) {
                        pdf.setFontSize(10);
                        pdf.text(`  Description: ${todo.description}`, margin + 20, yPos);
                        yPos += 15;
                    }
                });
                yPos += 10;
            }

            // --- Notes Section ---
            checkPageBreak(50);
            pdf.setFontSize(18);
            pdf.text('Mes Notes et Listes', margin, yPos);
            yPos += 25;
            if (appData.notes.length === 0 && appData.lists.length === 0) {
                pdf.setFontSize(12);
                pdf.text('Aucune note ou liste enregistrée.', margin, yPos);
                yPos += 20;
            } else {
                appData.notes.forEach(note => {
                    checkPageBreak(40);
                    pdf.setFontSize(12);
                    pdf.text(`- Note: ${note.title}`, margin + 10, yPos);
                    yPos += 15;
                    if (note.content) {
                        pdf.setFontSize(10);
                        pdf.text(`  Contenu: ${note.content}`, margin + 20, yPos);
                        yPos += 15;
                    }
                });
                appData.lists.forEach(list => {
                    checkPageBreak(40);
                    pdf.setFontSize(12);
                    pdf.text(`- Liste: ${list.title}`, margin + 10, yPos);
                    yPos += 15;
                    list.items.forEach(item => {
                        pdf.setFontSize(10);
                        pdf.text(`  - ${item.text} ${item.completed ? '[Terminé]' : ''}`, margin + 20, yPos);
                        yPos += 15;
                    });
                });
                yPos += 10;
            }

            // --- Expenses Section ---
            checkPageBreak(50);
            pdf.setFontSize(18);
            pdf.text('Historique des Dépenses et Revenus', margin, yPos);
            yPos += 25;
            if (appData.expenses.length === 0) {
                pdf.setFontSize(12);
                pdf.text('Aucune transaction enregistrée.', margin, yPos);
                yPos += 20;
            } else {
                const headers = ['Date', 'Description', 'Catégorie', 'Provenance', 'Montant (€)'];
                const data = appData.expenses.map(exp => {
                    const category = appData.categories.find(cat => cat.id === exp.category) || { name: exp.category };
                    const origin = appData.origins.find(org => org.id === exp.origin) || { name: exp.origin };
                    return [
                        new Date(exp.date).toLocaleDateString('fr-FR'),
                        exp.description,
                        category.name,
                        origin.name,
                        exp.amount.toFixed(2)
                    ];
                });
                pdf.autoTable({
                    startY: yPos,
                    head: [headers],
                    body: data,
                    theme: 'grid',
                    styles: { fontSize: 10, cellPadding: 5, textColor: '#333' },
                    headStyles: { fillColor: '#9333ea', textColor: '#fff', fontStyle: 'bold' },
                    columnStyles: {
                        4: { halign: 'right' } // Align amount column to the right
                    },
                    margin: { left: margin, right: margin },
                    didDrawPage: function (data) {
                        yPos = data.cursor.y + 10; // Update yPos after table
                    }
                });
                yPos = pdf.autoTable.previous.finalY + 10;
            }

            // --- Loans Section ---
            checkPageBreak(50);
            pdf.setFontSize(18);
            pdf.text('Mes Prêts', margin, yPos);
            yPos += 25;
            if (appData.loans.length === 0) {
                pdf.setFontSize(12);
                pdf.text('Aucun prêt enregistré.', margin, yPos);
                yPos += 20;
            } else {
                appData.loans.forEach(loan => {
                    checkPageBreak(40);
                    const remaining = (loan.amount - loan.paid).toFixed(2);
                    pdf.setFontSize(12);
                    pdf.text(`- ${loan.name}: Total: €${loan.amount.toFixed(2)}, Remboursé: €${loan.paid.toFixed(2)}, Restant: €${remaining} (Échéance: ${loan.dueDate || 'N/A'})`, margin + 10, yPos);
                    yPos += 15;
                });
                yPos += 10;
            }

            // --- Wellness Section (Summary) ---
            checkPageBreak(50);
            pdf.setFontSize(18);
            pdf.text('Résumé Bien-être', margin, yPos);
            yPos += 25;
            if (appData.wellness.length === 0) {
                pdf.setFontSize(12);
                pdf.text('Aucune entrée bien-être enregistrée.', margin, yPos);
                yPos += 20;
            } else {
                const wellnessTypes = ['weight', 'mood', 'sleep', 'exercise', 'water'];
                wellnessTypes.forEach(type => {
                    const entries = appData.wellness.filter(entry => entry.type === type);
                    if (entries.length > 0) {
                        checkPageBreak(20);
                        pdf.setFontSize(12);
                        pdf.text(`- ${type.charAt(0).toUpperCase() + type.slice(1)}:`, margin + 10, yPos);
                        yPos += 15;
                        entries.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 3).forEach(entry => { // Show last 3
                            let valueDisplay = '';
                            if (entry.type === 'mood') {
                                valueDisplay = `${entry.value}/5`;
                            } else if (entry.type === 'weight') {
                                valueDisplay = `${entry.value} kg`;
                            } else if (entry.type === 'sleep') {
                                valueDisplay = `${entry.value}h`;
                            } else if (entry.type === 'exercise') {
                                valueDisplay = `${entry.value} min`;
                            } else if (entry.type === 'water') {
                                valueDisplay = `${entry.value} verres`;
                            }
                            pdf.setFontSize(10);
                            pdf.text(`  ${new Date(entry.date).toLocaleDateString('fr-FR')}: ${valueDisplay} ${entry.notes ? `(${entry.notes})` : ''}`, margin + 20, yPos);
                            yPos += 15;
                        });
                    }
                });
                yPos += 10;
            }

            // --- Salary Forecast Section ---
            checkPageBreak(50);
            pdf.setFontSize(18);
            pdf.text('Prévisions Salariales', margin, yPos);
            yPos += 25;
            if (appData.salaryForecasts.length === 0) {
                pdf.setFontSize(12);
                pdf.text('Aucune prévision salariale enregistrée.', margin, yPos);
                yPos += 20;
            } else {
                appData.salaryForecasts.forEach(forecast => {
                    checkPageBreak(60 + forecast.expenses.length * 15);
                    let totalExpenses = forecast.expenses.reduce((sum, exp) => sum + exp.amount, 0);
                    let remainingSalary = forecast.averageSalary - totalExpenses;
                    pdf.setFontSize(12);
                    pdf.text(`- ${forecast.name}: Salaire Moyen: €${forecast.averageSalary.toFixed(2)}`, margin + 10, yPos);
                    yPos += 15;
                    pdf.setFontSize(10);
                    pdf.text(`  Dépenses Fixes:`, margin + 20, yPos);
                    yPos += 15;
                    if (forecast.expenses.length === 0) {
                        pdf.text(`    Aucune.`, margin + 30, yPos);
                        yPos += 15;
                    } else {
                        forecast.expenses.forEach(exp => {
                            pdf.text(`    - ${exp.description}: €${exp.amount.toFixed(2)}`, margin + 30, yPos);
                            yPos += 15;
                        });
                    }
                    pdf.setFontSize(12);
                    pdf.text(`  Total Dépenses: €${totalExpenses.toFixed(2)}`, margin + 20, yPos);
                    yPos += 15;
                    pdf.text(`  Reste après dépenses: €${remainingSalary.toFixed(2)}`, margin + 20, yPos);
                    yPos += 20;
                });
            }

            // --- Planned Expenses Section ---
            checkPageBreak(50);
            pdf.setFontSize(18);
            pdf.text('Dépenses Planifiées', margin, yPos);
            yPos += 25;
            if (appData.plannedExpenses.length === 0) {
                pdf.setFontSize(12);
                pdf.text('Aucune dépense planifiée enregistrée.', margin, yPos);
                yPos += 20;
            } else {
                appData.plannedExpenses.forEach(plannedExpense => {
                    checkPageBreak(60 + plannedExpense.items.length * 15);
                    let totalAmount = 0;
                    let totalPaid = 0;
                    
                    pdf.setFontSize(12);
                    pdf.text(`- ${plannedExpense.name}:`, margin + 10, yPos);
                    yPos += 15;
                    pdf.setFontSize(10);
                    pdf.text(`  Éléments:`, margin + 20, yPos);
                    yPos += 15;

                    if (plannedExpense.items.length === 0) {
                        pdf.text(`    Aucun élément planifié.`, margin + 30, yPos);
                        yPos += 15;
                    } else {
                        plannedExpense.items.forEach(item => {
                            totalAmount += item.amount;
                            if (item.paid) totalPaid += item.amount;
                            const status = item.paid ? '[Payé]' : '[Non payé]';
                            pdf.text(`    - ${item.description}: €${item.amount.toFixed(2)} ${status}`, margin + 30, yPos);
                            yPos += 15;
                        });
                    }

                    const remainingToPay = totalAmount - totalPaid;
                    
                    pdf.setFontSize(12);
                    pdf.text(`  Total Planifié: €${totalAmount.toFixed(2)}`, margin + 20, yPos);
                    yPos += 15;
                    pdf.text(`  Total Payé: €${totalPaid.toFixed(2)}`, margin + 20, yPos);
                    yPos += 15;
                    pdf.text(`  Reste à Payer: €${remainingToPay.toFixed(2)}`, margin + 20, yPos);
                    yPos += 20;
                });
            }

            pdf.save(`mon-espace-personnel-rapport-${new Date().toISOString().split('T')[0]}.pdf`);
        }


        // Modale de confirmation (pour la suppression)
        document.getElementById('confirmCancel').addEventListener('click', () => confirmModal.classList.add('hidden'));
        document.getElementById('confirmDelete').addEventListener('click', async () => { // Added async here
            if (itemToDelete) {
                const { type, id } = itemToDelete;
                
                switch(type) {
                    case 'todo':
                        appData.todos = appData.todos.filter(todo => todo.id !== id);
                        break;
                    case 'note':
                        appData.notes = appData.notes.filter(note => note.id !== id);
                        break;
                    case 'list':
                        appData.lists = appData.lists.filter(list => list.id !== id);
                        break;
                    case 'expense':
                        appData.expenses = appData.expenses.filter(expense => expense.id !== id);
                        break;
                    case 'wellness':
                        appData.wellness = appData.wellness.filter(entry => entry.id !== id);
                        break;
                    case 'category':
                        appData.categories = appData.categories.filter(cat => cat.id !== id);
                        // Reassign items with deleted category to a default or 'other'
                        appData.todos.forEach(todo => { if (todo.category === id) todo.category = 'other'; });
                        appData.expenses.forEach(expense => { if (expense.category === id) expense.category = 'other'; });
                        break;
                    case 'origin':
                        appData.origins = appData.origins.filter(org => org.id !== id);
                        appData.expenses.forEach(expense => { if (expense.origin === id) expense.origin = 'other-income'; }); // Reassign to a default
                        break;
                    case 'loan':
                        appData.loans = appData.loans.filter(loan => loan.id !== id);
                        break;
                    case 'salaryForecast':
                        appData.salaryForecasts = appData.salaryForecasts.filter(sf => sf.id !== id);
                        break;
                    case 'plannedExpense':
                        appData.plannedExpenses = appData.plannedExpenses.filter(pe => pe.id !== id);
                        break;
                }
                
                await saveData(); // Save changes to GitHub
                
                switch(type) {
                    case 'todo': renderTodos(); break;
                    case 'note': case 'list': renderNotes(); break;
                    case 'expense': renderExpenses(); renderLoans(); break;
                    case 'wellness': renderWellness(); updateCharts(); break;
                    case 'category': populateCategoryDropdowns(); renderCategoriesDisplay(); renderAllSections(); break;
                    case 'origin': populateOriginDropdowns(); renderOriginsDisplay(); renderAllSections(); break;
                    case 'loan': renderLoans(); updateFinancialSummary(); renderOverview(); break;
                    case 'salaryForecast': renderSalaryForecasts(); break;
                    case 'plannedExpense': renderPlannedExpenses(); break;
                }
            }
            
            confirmModal.classList.add('hidden');
            itemToDelete = null;
        });

        // Fonctions de rendu pour chaque section
        function renderOverview() {
            const activeTasks = appData.todos.filter(todo => !todo.completed).length;
            const totalTasks = appData.todos.length;
            const taskCompletionRate = totalTasks > 0 ? ((appData.todos.filter(t => t.completed).length / totalTasks) * 100).toFixed(0) : 0;

            let totalWellnessScore = 0;
            let wellnessEntriesCount = 0;
            appData.wellness.forEach(entry => {
                if (entry.type === 'mood' && entry.value) {
                    totalWellnessScore += parseInt(entry.value);
                    wellnessEntriesCount++;
                }
            });
            const wellnessIndex = wellnessEntriesCount > 0 ? (totalWellnessScore / wellnessEntriesCount).toFixed(1) : 'N/A';

            document.getElementById('overviewActiveTasks').textContent = activeTasks;
            document.getElementById('overviewTaskCompletion').textContent = `${taskCompletionRate}%`;
            document.getElementById('overviewWellnessIndex').textContent = wellnessIndex;
            document.getElementById('overviewCurrentBalance').textContent = `€${calculateCurrentBalance().toFixed(2)}`;
            document.getElementById('overviewSavingsBalance').textContent = `€${appData.savings.balance.toFixed(2)}`;
            document.getElementById('overviewLoansRemaining').textContent = `€${calculateTotalLoansRemaining().toFixed(2)}`;

            renderExpenseCategoryChart();
        }

        function renderTodos(filter = 'all') {
            todosContainer.innerHTML = '';
            
            let todosToRender = [...appData.todos];
            
            if (filter === 'active') {
                todosToRender = todosToRender.filter(todo => !todo.completed);
            } else if (filter === 'completed') {
                todosToRender = todosToRender.filter(todo => todo.completed);
            } else if (filter === 'today') {
                const today = new Date().toISOString().split('T')[0];
                todosToRender = todosToRender.filter(todo => todo.dueDate === today);
            } else if (filter === 'thisWeek') {
                const today = moment();
                todosToRender = todosToRender.filter(todo => {
                    const dueDate = moment(todo.dueDate);
                    return dueDate.isValid() && dueDate.isSame(today, 'week');
                });
            } else if (filter === 'thisMonth') { // Nouveau filtre
                const currentMonth = new Date().toISOString().substring(0, 7);
                todosToRender = todosToRender.filter(todo => todo.dueDate && todo.dueDate.substring(0, 7) === currentMonth);
            }
            
            todosToRender.sort((a, b) => {
                const priorityOrder = { high: 1, medium: 2, low: 3 };
                if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
                    return priorityOrder[a.priority] - priorityOrder[b.priority];
                }
                return new Date(a.dueDate) - new Date(b.dueDate);
            });
            
            if (todosToRender.length === 0) {
                todosContainer.innerHTML = `
                    <div class="lg:col-span-3 text-center py-8 text-purple-600">
                        <i class="fas fa-tasks text-4xl mb-2"></i>
                        <p>Aucune tâche à afficher</p>
                    </div>
                `;
                // Update tasks progress text even if no tasks
                const completedTodosCount = appData.todos.filter(todo => todo.completed).length;
                const totalTodosCount = appData.todos.length;
                document.getElementById('tasksProgressText').textContent = `${completedTodosCount}/${totalTodosCount}`;
                return;
            }
            
            todosToRender.forEach(todo => {
                const todoElement = document.createElement('div');
                let cardClass = `draggable bg-white border rounded-lg p-4 hover:shadow-md transition min-h-48 max-h-64 overflow-y-auto `;
                if (todo.completed) {
                    cardClass += 'opacity-70 border-green-300';
                } else {
                    const today = new Date();
                    const dueDate = new Date(todo.dueDate);
                    const diffTime = dueDate.getTime() - today.getTime();
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    if (todo.priority === 'high' && diffDays <= 7) {
                        cardClass += 'border-red-300';
                    } else if (todo.priority === 'medium' && diffDays <= 3) {
                        cardClass += 'border-yellow-300';
                    } else {
                        cardClass += 'border-purple-200';
                    }
                }
                todoElement.className = cardClass;
                todoElement.dataset.id = todo.id;
                todoElement.draggable = true;
                
                const category = appData.categories.find(cat => cat.id === todo.category) || { name: todo.category, color: '#9333ea' };
                
                todoElement.innerHTML = `
                    <div class="flex items-start justify-between mb-2">
                        <div class="flex items-center flex-grow">
                            <input type="checkbox" class="form-checkbox h-5 w-5 text-purple-600 rounded mr-3" ${todo.completed ? 'checked' : ''} onchange="toggleTodoCompletion('${todo.id}')">
                            <div class="flex-grow">
                                <h3 class="text-lg font-semibold text-purple-800" contenteditable="true" onblur="editTodoField('${todo.id}', 'title', this.innerText)">${todo.title}</h3>
                                <p class="text-sm text-gray-600" contenteditable="true" onblur="editTodoField('${todo.id}', 'description', this.innerText)">${todo.description || 'Pas de description'}</p>
                            </div>
                        </div>
                        <div class="flex-shrink-0 ml-4">
                            <button onclick="openTodoModalForEdit('${todo.id}')" class="text-purple-600 hover:text-purple-800 mr-2">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="confirmDeletion('todo', '${todo.id}')" class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex items-center justify-between text-sm text-gray-500 mt-2">
                        <div class="flex items-center">
                            <i class="fas fa-calendar-alt mr-1"></i>
                            <span>${todo.dueDate ? new Date(todo.dueDate).toLocaleDateString('fr-FR') : 'Pas de date'}</span>
                            <span class="ml-3 px-2 py-0.5 rounded-full text-xs font-medium" style="background-color: ${category.color}; color: white;">
                                ${category.name}
                            </span>
                        </div>
                        <span class="px-2 py-0.5 rounded-full text-xs font-medium ${
                            todo.priority === 'high' ? 'bg-red-100 text-red-800' :
                            todo.priority === 'medium' ? 'bg-yellow-100 text-yellow-800' :
                            'bg-green-100 text-green-800'
                        }">
                            ${todo.priority === 'high' ? 'Haute' : todo.priority === 'medium' ? 'Moyenne' : 'Basse'}
                        </span>
                    </div>
                `;
                todosContainer.appendChild(todoElement);
            });
            addDragAndDropListeners(todosContainer, 'todos');

            const completedTodosCount = appData.todos.filter(todo => todo.completed).length;
            const totalTodosCount = appData.todos.length;
            document.getElementById('tasksProgressText').textContent = `${completedTodosCount}/${totalTodosCount}`;
        }

        async function toggleTodoCompletion(id) { // Added async here
            const todo = appData.todos.find(t => t.id === id);
            if (todo) {
                todo.completed = !todo.completed;
                await saveData(); // Save changes to GitHub
                renderTodos(document.querySelector('.todo-filter-btn.bg-purple-600').dataset.filter);
            }
        }

        async function editTodoField(id, field, newValue) { // Added async here
            const todo = appData.todos.find(t => t.id === id);
            if (todo) {
                todo[field] = newValue;
                await saveData(); // Save changes to GitHub
            }
        }

        function openTodoModalForEdit(id) {
            const todo = appData.todos.find(t => t.id === id);
            if (todo) {
                document.getElementById('todoId').value = todo.id;
                document.getElementById('todoTitle').value = todo.title;
                document.getElementById('todoDescription').value = todo.description;
                document.getElementById('todoDueDate').value = todo.dueDate;
                document.getElementById('todoPriority').value = todo.priority;
                document.getElementById('todoCategory').value = todo.category;
                todoModal.classList.remove('hidden');
            }
        }

        function renderNotes() {
            notesContainer.innerHTML = '';

            const allNotesAndLists = [
                ...appData.notes.map(n => ({ ...n, type: 'note' })),
                ...appData.lists.map(l => ({ ...l, type: 'list' }))
            ];

            if (allNotesAndLists.length === 0) {
                notesContainer.innerHTML = `
                    <div class="lg:col-span-3 text-center py-8 text-purple-600">
                        <i class="fas fa-sticky-note text-4xl mb-2"></i>
                        <p>Aucune note ou liste à afficher</p>
                    </div>
                `;
                return;
            }

            allNotesAndLists.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = `draggable bg-white rounded-lg shadow-md p-4 transition ${item.color} min-h-48 max-h-64 overflow-y-auto`;
                itemElement.dataset.id = item.id;
                itemElement.dataset.type = item.type;
                itemElement.draggable = true;

                if (item.type === 'note') {
                    itemElement.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-lg font-semibold text-purple-800" contenteditable="true" onblur="editNoteField('${item.id}', 'title', this.innerText)">${item.title}</h3>
                            <div class="flex-shrink-0 ml-4">
                                <button onclick="openNoteModalForEdit('${item.id}')" class="text-purple-600 hover:text-purple-800 mr-2">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="confirmDeletion('note', '${item.id}')" class="text-red-600 hover:text-red-800">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <p class="text-sm text-gray-600" contenteditable="true" onblur="editNoteField('${item.id}', 'content', this.innerText)">${item.content}</p>
                    `;
                } else if (item.type === 'list') {
                    const listItemsHtml = item.items.map((listItem, idx) => `
                        <div class="flex items-center text-sm text-gray-700">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-purple-600 rounded mr-2" ${listItem.completed ? 'checked' : ''} onchange="toggleListItemCompletion('${item.id}', ${idx})">
                            <span class="${listItem.completed ? 'line-through text-gray-500' : ''}" contenteditable="true" onblur="editListItemText('${item.id}', ${idx}, this.innerText)">${listItem.text}</span>
                        </div>
                    `).join('');
                    itemElement.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="text-lg font-semibold text-purple-800" contenteditable="true" onblur="editListField('${item.id}', 'title', this.innerText)">${item.title}</h3>
                            <div class="flex-shrink-0 ml-4">
                                <button onclick="openListModalForEdit('${item.id}')" class="text-purple-600 hover:text-purple-800 mr-2">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="confirmDeletion('list', '${item.id}')" class="text-red-600 hover:text-red-800">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                        <div class="space-y-1 mt-2">
                            ${listItemsHtml}
                        </div>
                    `;
                }
                notesContainer.appendChild(itemElement);
            });
            addDragAndDropListeners(notesContainer, 'notesAndLists');
        }

        async function editNoteField(id, field, newValue) { // Added async here
            const note = appData.notes.find(n => n.id === id);
            if (note) {
                note[field] = newValue;
                await saveData(); // Save changes to GitHub
            }
        }

        function openNoteModalForEdit(id) {
            const note = appData.notes.find(n => n.id === id);
            if (note) {
                document.getElementById('noteId').value = note.id;
                document.getElementById('noteTitle').value = note.title;
                document.getElementById('noteContent').value = note.content;
                document.getElementById('noteColor').value = note.color;
                noteModal.classList.remove('hidden');
            }
        }

        async function toggleListItemCompletion(listId, itemIndex) { // Added async here
            const list = appData.lists.find(l => l.id === listId);
            if (list && list.items[itemIndex]) {
                list.items[itemIndex].completed = !list.items[itemIndex].completed;
                await saveData(); // Save changes to GitHub
                renderNotes();
            }
        }

        async function editListItemText(listId, itemIndex, newText) { // Added async here
            const list = appData.lists.find(l => l.id === listId);
            if (list && list.items[itemIndex]) {
                list.items[itemIndex].text = newText;
                await saveData(); // Save changes to GitHub
            }
        }

        async function editListField(id, field, newValue) { // Added async here
            const list = appData.lists.find(l => l.id === id);
            if (list) {
                list[field] = newValue;
                await saveData(); // Save changes to GitHub
            }
        }

        function openListModalForEdit(id) {
            const list = appData.lists.find(l => l.id === id);
            if (list) {
                document.getElementById('listId').value = list.id;
                document.getElementById('listTitle').value = list.title;
                document.getElementById('listColor').value = list.color;
                const container = document.getElementById('listItemsContainer');
                container.innerHTML = '';
                list.items.forEach(item => {
                    addListItemToContainer('listItemsContainer', item.text, item.completed);
                });
                listModal.classList.remove('hidden');
            }
        }

        function renderExpenses(filter = 'all') {
            expensesContainer.innerHTML = '';
            let totalMonthlyExpenses = 0;
            const currentMonth = new Date().toISOString().substring(0, 7);
            const startOfWeek = moment().startOf('week');
            const endOfWeek = moment().endOf('week');

            let expensesToRender = [...appData.expenses];

            if (filter === 'thisMonth') {
                expensesToRender = expensesToRender.filter(expense => expense.date.substring(0, 7) === currentMonth);
            } else if (filter === 'thisWeek') {
                expensesToRender = expensesToRender.filter(expense => {
                    const expenseDate = moment(expense.date);
                    return expenseDate.isBetween(startOfWeek, endOfWeek, null, '[]');
                });
            }

            const sortedExpenses = expensesToRender.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (sortedExpenses.length === 0) {
                expensesContainer.innerHTML = `
                    <tr><td colspan="6" class="text-center py-8 text-purple-600">
                        <i class="fas fa-wallet text-4xl mb-2"></i>
                        <p>Aucune dépense ou revenu à afficher pour ce filtre</p>
                    </td></tr>
                `;
            }

            sortedExpenses.forEach(expense => {
                const expenseDate = new Date(expense.date).toLocaleDateString('fr-FR');
                const category = appData.categories.find(cat => cat.id === expense.category) || { name: expense.category, color: '#64748b' };
                const origin = appData.origins.find(org => org.id === expense.origin) || { name: org.origin, color: '#64748b' };

                if (expense.date.substring(0, 7) === currentMonth && expense.amount < 0) {
                    totalMonthlyExpenses += Math.abs(expense.amount);
                }

                const tr = document.createElement('tr');
                tr.className = 'border-b last:border-b-0';
                tr.dataset.id = expense.id;
                tr.draggable = true;

                tr.innerHTML = `
                    <td class="py-3">${expenseDate}</td>
                    <td class="py-3" contenteditable="true" onblur="editExpenseField('${expense.id}', 'description', this.innerText)">${expense.description}</td>
                    <td class="py-3">
                        <span class="px-2 py-0.5 rounded-full text-xs font-medium" style="background-color: ${category.color}; color: white;">
                            ${category.name}
                        </span>
                    </td>
                    <td class="py-3">
                        <span class="px-2 py-0.5 rounded-full text-xs font-medium" style="background-color: ${origin.color}; color: white;">
                            ${origin.name}
                        </span>
                    </td>
                    <td class="py-3 text-right font-semibold ${expense.amount < 0 ? 'text-red-600' : 'text-green-600'}" contenteditable="true" onblur="editExpenseField('${expense.id}', 'amount', parseFloat(this.innerText))">${expense.amount.toFixed(2)} €</td>
                    <td class="py-3 text-center">
                        <button onclick="openExpenseModalForEdit('${expense.id}')" class="text-purple-600 hover:text-purple-800 mr-2">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="confirmDeletion('expense', '${expense.id}')" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                expensesContainer.appendChild(tr);
            });
            addDragAndDropListeners(expensesContainer, 'expenses');
            updateFinancialSummary();
        }

        async function editExpenseField(id, field, newValue) { // Added async here
            const expense = appData.expenses.find(e => e.id === id);
            if (expense) {
                if (field === 'amount') {
                    newValue = parseFloat(newValue);
                    if (isNaN(newValue)) { showMessage('Erreur', 'Montant invalide.'); renderExpenses(); return; }
                    if (expense.amount < 0 && newValue > 0) newValue = -newValue;
                    if (expense.amount > 0 && newValue < 0) newValue = Math.abs(newValue);
                }
                expense[field] = newValue;
                await saveData(); // Save changes to GitHub
                renderExpenses(document.querySelector('.expense-filter-btn.bg-purple-600').dataset.filter);
            }
        }

        function openExpenseModalForEdit(id) {
            const expense = appData.expenses.find(e => e.id === id);
            if (expense) {
                document.getElementById('expenseId').value = expense.id;
                document.getElementById('expenseDate').value = expense.date;
                document.getElementById('expenseDescription').value = expense.description;
                document.getElementById('expenseCategory').value = expense.category;
                document.getElementById('expenseOrigin').value = expense.origin;
                document.getElementById('expenseAmount').value = Math.abs(expense.amount);
                expenseModal.classList.remove('hidden');
            }
        }

        function calculateCurrentBalance() {
            let balance = 0;
            appData.expenses.forEach(transaction => {
                balance += transaction.amount;
            });
            return balance;
        }

        function calculateTotalLoansRemaining() {
            let totalRemaining = 0;
            appData.loans.forEach(loan => {
                totalRemaining += (loan.amount - loan.paid);
            });
            return totalRemaining;
        }

        function updateFinancialSummary() {
            document.getElementById('currentBalance').textContent = `€${calculateCurrentBalance().toFixed(2)}`;
            document.getElementById('totalSavings').textContent = `€${appData.savings.balance.toFixed(2)}`;
            document.getElementById('totalLoansRemaining').textContent = `€${calculateTotalLoansRemaining().toFixed(2)}`;
        }

        function renderLoans() {
            loansContainer.innerHTML = '';
            if (appData.loans.length === 0) {
                loansContainer.innerHTML = `
                    <div class="text-center py-8 text-purple-600">
                        <i class="fas fa-hand-holding-usd text-4xl mb-2"></i>
                        <p>Aucun prêt à afficher</p>
                    </div>
                `;
                return;
            }

            appData.loans.forEach(loan => {
                const remainingAmount = (loan.amount - loan.paid).toFixed(2);
                const loanElement = document.createElement('div');
                loanElement.className = `bg-white border border-purple-200 rounded-lg p-4 hover:shadow-md transition`;
                loanElement.dataset.id = loan.id;
                loanElement.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-lg font-semibold text-purple-800" contenteditable="true" onblur="editLoanField('${loan.id}', 'name', this.innerText)">${loan.name}</h3>
                        <div class="flex-shrink-0 ml-4">
                            <button onclick="openLoanModalForEdit('${loan.id}')" class="text-purple-600 hover:text-purple-800 mr-2">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="confirmDeletion('loan', '${loan.id}')" class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600">Montant Total: <span class="font-medium">€${loan.amount.toFixed(2)}</span></p>
                    <p class="text-sm text-gray-600">Remboursé: <span class="font-medium">€${loan.paid.toFixed(2)}</span></p>
                    <p class="text-sm text-gray-600">Restant: <span class="font-bold ${remainingAmount > 0 ? 'text-red-600' : 'text-green-600'}">€${remainingAmount}</span></p>
                    <p class="text-sm text-gray-500">Date d'échéance: ${loan.dueDate ? new Date(loan.dueDate).toLocaleDateString('fr-FR') : 'Non spécifiée'}</p>
                    <div class="mt-3">
                        <label for="repayLoan-${loan.id}" class="block text-sm font-medium text-purple-700 mb-1">Rembourser (€)</label>
                        <div class="flex">
                            <input type="number" step="0.01" id="repayLoan-${loan.id}" class="w-full px-3 py-1 border border-purple-300 rounded-l-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                            <button onclick="repayLoan('${loan.id}')" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-1 rounded-r-lg transition">Payer</button>
                        </div>
                    </div>
                `;
                loansContainer.appendChild(loanElement);
            });
        }

        async function editLoanField(id, field, newValue) { // Added async here
            const loan = appData.loans.find(l => l.id === id);
            if (loan) {
                if (field === 'amount' || field === 'paid') {
                    newValue = parseFloat(newValue);
                    if (isNaN(newValue) || newValue < 0) { showMessage('Erreur', 'Montant invalide.'); renderLoans(); return; }
                }
                loan[field] = newValue;
                await saveData(); // Save changes to GitHub
                renderLoans();
            }
        }

        function openLoanModalForEdit(id) {
            const loan = appData.loans.find(l => l.id === id);
            if (loan) {
                document.getElementById('loanId').value = loan.id;
                document.getElementById('loanName').value = loan.name;
                document.getElementById('loanAmount').value = loan.amount;
                document.getElementById('loanPaid').value = loan.paid;
                document.getElementById('loanDueDate').value = loan.dueDate;
                loanModal.classList.remove('hidden');
            }
        }

        async function repayLoan(id) { // Added async here
            const loan = appData.loans.find(l => l.id === id);
            const repaymentAmountInput = document.getElementById(`repayLoan-${id}`);
            const repaymentAmount = parseFloat(repaymentAmountInput.value);

            if (loan && !isNaN(repaymentAmount) && repaymentAmount > 0) {
                if (loan.paid + repaymentAmount > loan.amount) {
                    showMessage('Erreur', `Le montant du remboursement dépasse le solde restant. Montant restant : €${(loan.amount - loan.paid).toFixed(2)}`);
                    return;
                }
                loan.paid += repaymentAmount;
                const repaymentExpense = {
                    id: generateId(),
                    date: new Date().toISOString().split('T')[0],
                    description: `Remboursement de prêt: ${loan.name}`,
                    category: 'finance',
                    origin: 'loan-repayment',
                    amount: -repaymentAmount,
                    createdAt: new Date().toISOString()
                };
                appData.expenses.push(repaymentExpense);

                await saveData(); // Save changes to GitHub
                renderLoans();
                renderExpenses(document.querySelector('.expense-filter-btn.bg-purple-600').dataset.filter);
            } else {
                showMessage('Erreur', 'Veuillez entrer un montant de remboursement valide.');
            }
        }

        function renderSavingsModal() {
            document.getElementById('savingsCurrentBalance').textContent = `€${appData.savings.balance.toFixed(2)}`;
            savingsTransactionsContainer.innerHTML = '';

            if (appData.savings.transactions.length === 0) {
                savingsTransactionsContainer.innerHTML = `
                    <div class="text-center py-4 text-purple-600">
                        <p>Aucune transaction d'épargne enregistrée.</p>
                    </div>
                `;
                return;
            }

            const sortedTransactions = [...appData.savings.transactions].sort((a, b) => new Date(b.date) - new Date(a.date));

            sortedTransactions.forEach(transaction => {
                const transactionElement = document.createElement('div');
                const typeClass = transaction.type === 'deposit' ? 'text-green-600' : 'text-red-600';
                const typeIcon = transaction.type === 'deposit' ? '<i class="fas fa-arrow-down mr-1"></i>' : '<i class="fas fa-arrow-up mr-1"></i>';
                const description = transaction.description ? ` (${transaction.description})` : '';
                transactionElement.className = `flex justify-between items-center bg-purple-50 p-2 rounded-lg`;
                transactionElement.innerHTML = `
                    <p class="text-sm text-gray-700">
                        ${typeIcon} ${new Date(transaction.date).toLocaleDateString('fr-FR')} - ${transaction.type === 'deposit' ? 'Dépôt' : 'Retrait'}${description}
                    </p>
                    <span class="font-semibold ${typeClass}">€${transaction.amount.toFixed(2)}</span>
                `;
                savingsTransactionsContainer.appendChild(transactionElement);
            });
        }

        function renderWellness() {
            wellnessContainer.innerHTML = '';
            
            if (appData.wellness.length === 0) {
                wellnessContainer.innerHTML = `
                    <div class="text-center py-8 text-purple-600">
                        <i class="fas fa-heartbeat text-4xl mb-2"></i>
                        <p>Aucune entrée bien-être à afficher. Ajoutez-en une pour voir les statistiques !</p>
                    </div>
                `;
            } else {
                 const sortedWellness = [...appData.wellness].sort((a, b) => new Date(b.date) - new Date(a.date));
                 sortedWellness.slice(0, 5).forEach(entry => {
                    const entryElement = document.createElement('div');
                    entryElement.className = `bg-white border border-purple-200 rounded-lg p-3 hover:shadow-md transition flex justify-between items-center`;
                    let valueDisplay = '';
                    let icon = '';
                    switch (entry.type) {
                        case 'weight': valueDisplay = `${entry.value} kg`; icon = '<i class="fas fa-weight"></i>'; break;
                        case 'mood': 
                            const moodIcons = { '1': 'fa-frown', '2': 'fa-meh', '3': 'fa-smile', '4': 'fa-laugh', '5': 'fa-grin-hearts' };
                            valueDisplay = `<i class="fas ${moodIcons[entry.value]}"></i>`; 
                            break;
                        case 'sleep': valueDisplay = `${entry.value}h`; icon = '<i class="fas fa-moon"></i>'; break;
                        case 'exercise': valueDisplay = `${entry.value} min`; icon = '<i class="fas fa-running"></i>'; break;
                        case 'water': valueDisplay = `${entry.value} verres`; icon = '<i class="fas fa-water"></i>'; break;
                    }
                    entryElement.innerHTML = `
                        <p class="text-sm text-gray-700">${new Date(entry.date).toLocaleDateString('fr-FR')} - ${entry.type.charAt(0).toUpperCase() + entry.type.slice(1)}: <span class="font-semibold">${valueDisplay}</span></p>
                        <div>
                            <button onclick="openWellnessModalForEdit('${entry.id}')" class="text-purple-600 hover:text-purple-800 mr-2"><i class="fas fa-edit"></i></button>
                            <button onclick="confirmDeletion('wellness', '${entry.id}')" class="text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>
                        </div>
                    `;
                    wellnessContainer.appendChild(entryElement);
                 });
            }
        }

        async function editWellnessField(id, field, newValue) { // Added async here
            const entry = appData.wellness.find(e => e.id === id);
            if (entry) {
                entry[field] = newValue;
                await saveData(); // Save changes to GitHub
                renderWellness();
                updateCharts();
            }
        }

        function openWellnessModalForEdit(id) {
            const entry = appData.wellness.find(e => e.id === id);
            if (entry) {
                document.getElementById('wellnessId').value = entry.id;
                document.getElementById('wellnessDate').value = entry.date;
                document.getElementById('wellnessType').value = entry.type;
                document.getElementById('wellnessNotes').value = entry.notes;

                updateWellnessFormFields();

                if (entry.type === 'mood') {
                    document.getElementById('wellnessMood').value = entry.value;
                    document.querySelectorAll('.mood-btn').forEach(btn => {
                        if (btn.dataset.mood === String(entry.value)) {
                            btn.classList.add('bg-purple-100');
                        } else {
                            btn.classList.remove('bg-purple-100');
                        }
                    });
                } else {
                    document.getElementById('wellnessValue').value = entry.value;
                }
                wellnessModal.classList.remove('hidden');
            }
        }

        function renderSalaryForecasts() {
            salaryForecastContainer.innerHTML = '';

            if (appData.salaryForecasts.length === 0) {
                salaryForecastContainer.innerHTML = `
                    <div class="text-center py-8 text-purple-600">
                        <i class="fas fa-money-bill-wave text-4xl mb-2"></i>
                        <p>Aucune prévision salariale enregistrée.</p>
                    </div>
                `;
                return;
            }

            appData.salaryForecasts.forEach(forecast => {
                let totalExpenses = 0;
                const expensesHtml = forecast.expenses.map(exp => {
                    totalExpenses += exp.amount;
                    return `<p class="text-sm text-gray-600 ml-4">- ${exp.description}: €${exp.amount.toFixed(2)}</p>`;
                }).join('');

                const remainingSalary = forecast.averageSalary - totalExpenses;
                const remainingClass = remainingSalary >= 0 ? 'text-green-600' : 'text-red-600';

                const forecastElement = document.createElement('div');
                forecastElement.className = `bg-white border border-purple-200 rounded-lg p-4 hover:shadow-md transition`;
                forecastElement.dataset.id = forecast.id;
                forecastElement.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-lg font-semibold text-purple-800" contenteditable="true" onblur="editSalaryForecastField('${forecast.id}', 'name', this.innerText)">${forecast.name}</h3>
                        <div class="flex-shrink-0 ml-4">
                            <button onclick="openSalaryForecastModalForEdit('${forecast.id}')" class="text-purple-600 hover:text-purple-800 mr-2">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="confirmDeletion('salaryForecast', '${forecast.id}')" class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <p class="text-sm text-gray-600">Salaire Moyen: <span class="font-medium">€${forecast.averageSalary.toFixed(2)}</span></p>
                    <h4 class="text-md font-semibold text-purple-700 mt-3 mb-1">Dépenses Fixes:</h4>
                    ${expensesHtml || '<p class="text-sm text-gray-500 ml-4">Aucune dépense fixe.</p>'}
                    <p class="text-md font-bold text-purple-800 mt-3">Total Dépenses: €${totalExpenses.toFixed(2)}</p>
                    <p class="text-md font-bold mt-1 ${remainingClass}">Reste après dépenses: €${remainingSalary.toFixed(2)}</p>
                `;
                salaryForecastContainer.appendChild(forecastElement);
            });
        }

        async function editSalaryForecastField(id, field, newValue) { // Added async here
            const forecast = appData.salaryForecasts.find(sf => sf.id === id);
            if (forecast) {
                if (field === 'averageSalary') {
                    newValue = parseFloat(newValue);
                    if (isNaN(newValue) || newValue < 0) { showMessage('Erreur', 'Montant invalide.'); renderSalaryForecasts(); return; }
                }
                forecast[field] = newValue;
                await saveData(); // Save changes to GitHub
                renderSalaryForecasts();
            }
        }

        function openSalaryForecastModalForEdit(id) {
            const forecast = appData.salaryForecasts.find(sf => sf.id === id);
            if (forecast) {
                document.getElementById('salaryForecastId').value = forecast.id;
                document.getElementById('salaryForecastName').value = forecast.name;
                document.getElementById('salaryForecastAverageSalary').value = forecast.averageSalary;
                const container = document.getElementById('salaryForecastExpensesContainer');
                container.innerHTML = '';
                forecast.expenses.forEach(expense => {
                    addSalaryForecastExpenseItemToContainer('salaryForecastExpensesContainer', expense.description, expense.amount);
                });
                updateSalaryForecastTotals(); // Update totals when opening for edit
                salaryForecastModal.classList.remove('hidden');
            }
        }

        function renderPlannedExpenses() {
            plannedExpensesContainer.innerHTML = '';

            if (appData.plannedExpenses.length === 0) {
                plannedExpensesContainer.innerHTML = `
                    <div class="text-center py-8 text-purple-600">
                        <i class="fas fa-clipboard-list text-4xl mb-2"></i>
                        <p>Aucune dépense planifiée enregistrée.</p>
                    </div>
                `;
                return;
            }

            appData.plannedExpenses.forEach(plannedExpense => {
                let totalAmount = 0;
                let totalPaid = 0;
                const itemsHtml = plannedExpense.items.map((item, idx) => {
                    totalAmount += item.amount;
                    if (item.paid) totalPaid += item.amount;
                    const itemClass = item.paid ? 'line-through text-gray-500' : '';
                    return `
                        <div class="flex items-center text-sm text-gray-700 ml-4">
                            <input type="checkbox" class="form-checkbox h-4 w-4 text-purple-600 rounded mr-2" ${item.paid ? 'checked' : ''} onchange="togglePlannedExpenseItemPaid('${plannedExpense.id}', ${idx})">
                            <span class="${itemClass}">${item.description}: €${item.amount.toFixed(2)}</span>
                            ${!item.paid ? `<button onclick="payPlannedExpenseItem('${plannedExpense.id}', ${idx})" class="ml-auto bg-green-500 hover:bg-green-600 text-white text-xs px-2 py-1 rounded-full">Payer</button>` : ''}
                        </div>
                    `;
                }).join('');

                const remainingToPay = totalAmount - totalPaid;
                const remainingClass = remainingToPay > 0 ? 'text-red-600' : 'text-green-600';

                const plannedExpenseElement = document.createElement('div');
                plannedExpenseElement.className = `bg-white border border-purple-200 rounded-lg p-4 hover:shadow-md transition`;
                plannedExpenseElement.dataset.id = plannedExpense.id;
                plannedExpenseElement.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-lg font-semibold text-purple-800" contenteditable="true" onblur="editPlannedExpenseField('${plannedExpense.id}', 'name', this.innerText)">${plannedExpense.name}</h3>
                        <div class="flex-shrink-0 ml-4">
                            <button onclick="openPlannedExpenseModalForEdit('${plannedExpense.id}')" class="text-purple-600 hover:text-purple-800 mr-2">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="confirmDeletion('plannedExpense', '${plannedExpense.id}')" class="text-red-600 hover:text-red-800">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <h4 class="text-md font-semibold text-purple-700 mt-3 mb-1">Éléments:</h4>
                    ${itemsHtml || '<p class="text-sm text-gray-500 ml-4">Aucun élément planifié.</p>'}
                    <p class="text-md font-bold text-purple-800 mt-3">Total Planifié: €${totalAmount.toFixed(2)}</p>
                    <p class="text-md font-bold mt-1">Total Payé: <span class="text-green-600">€${totalPaid.toFixed(2)}</span></p>
                    <p class="text-md font-bold mt-1 ${remainingClass}">Reste à Payer: €${remainingToPay.toFixed(2)}</p>
                `;
                plannedExpensesContainer.appendChild(plannedExpenseElement);
            });
        }

        async function editPlannedExpenseField(id, field, newValue) { // Added async here
            const plannedExpense = appData.plannedExpenses.find(pe => pe.id === id);
            if (plannedExpense) {
                plannedExpense[field] = newValue;
                await saveData(); // Save changes to GitHub
                renderPlannedExpenses();
            }
        }

        function openPlannedExpenseModalForEdit(id) {
            const plannedExpense = appData.plannedExpenses.find(pe => pe.id === id);
            if (plannedExpense) {
                document.getElementById('plannedExpenseId').value = plannedExpense.id;
                document.getElementById('plannedExpenseName').value = plannedExpense.name;
                const container = document.getElementById('plannedExpenseItemsContainer');
                container.innerHTML = '';
                plannedExpense.items.forEach(item => {
                    addPlannedExpenseItemToContainer('plannedExpenseItemsContainer', item.description, item.amount, item.paid);
                });
                plannedExpenseModal.classList.remove('hidden');
            }
        }

        async function togglePlannedExpenseItemPaid(plannedExpenseId, itemIndex) { // Added async here
            const plannedExpense = appData.plannedExpenses.find(pe => pe.id === plannedExpenseId);
            if (plannedExpense && plannedExpense.items[itemIndex]) {
                plannedExpense.items[itemIndex].paid = !plannedExpense.items[itemIndex].paid;
                await saveData(); // Save changes to GitHub
                renderPlannedExpenses();
            }
        }

        async function payPlannedExpenseItem(plannedExpenseId, itemIndex) { // Added async here
            const plannedExpense = appData.plannedExpenses.find(pe => pe.id === plannedExpenseId);
            if (plannedExpense && plannedExpense.items[itemIndex]) {
                const item = plannedExpense.items[itemIndex];
                if (item.paid) {
                    showMessage('Information', 'Cet élément est déjà payé.');
                    return;
                }

                item.paid = true;

                const newExpense = {
                    id: generateId(),
                    date: new Date().toISOString().split('T')[0],
                    description: `Dépense planifiée: ${plannedExpense.name} - ${item.description}`,
                    category: 'other',
                    origin: 'cash',
                    amount: -item.amount,
                    createdAt: new Date().toISOString()
                };
                appData.expenses.push(newExpense);

                await saveData(); // Save changes to GitHub
                renderPlannedExpenses();
                renderExpenses(document.querySelector('.expense-filter-btn.bg-purple-600').dataset.filter);
            }
        }


        // Mise à jour des statistiques (barres de progression)
        function updateStats() {
            // Logic for updating overall stats, not progress bars in sidebar anymore
        }

        // Initialisation des graphiques (Chart.js)
        function initCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: {} }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'day', tooltipFormat: 'DD/MM/YYYY', displayFormats: { day: 'DD/MM' } },
                        title: { display: true, text: 'Date', color: '#6B7280' },
                        ticks: { color: '#6B7280' },
                        grid: { color: 'rgba(107, 114, 128, 0.1)' }
                    },
                    y: {
                        beginAtZero: true,
                        title: { display: true, text: 'Valeur', color: '#6B7280' },
                        ticks: { color: '#6B7280' },
                        grid: { color: 'rgba(107, 114, 128, 0.1)' }
                    }
                }
            };

            const weightCtx = document.getElementById('weightChart').getContext('2d');
            if (weightChartInstance) weightChartInstance.destroy();
            weightChartInstance = new Chart(weightCtx, {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'Poids (kg)', data: [], borderColor: '#9333ea', backgroundColor: 'rgba(147, 51, 234, 0.2)', tension: 0.1, fill: true }] },
                options: { ...chartOptions, plugins: { ...chartOptions.plugins, tooltip: { callbacks: { label: function(context) { return `${context.dataset.label}: ${context.raw} kg`; } } } }, scales: { ...chartOptions.scales, y: { ...chartOptions.scales.y, title: { display: true, text: 'Poids (kg)', color: '#6B7280' } } } }
            });

            const moodCtx = document.getElementById('moodChart').getContext('2d');
            if (moodChartInstance) moodChartInstance.destroy();
            moodChartInstance = new Chart(moodCtx, {
                type: 'bar',
                data: { labels: ['1 (Très mauvais)', '2 (Mauvais)', '3 (Neutre)', '4 (Bon)', '5 (Très bon)'], datasets: [{ label: 'Fréquence d\'humeur', data: [0, 0, 0, 0, 0], backgroundColor: ['rgba(239, 68, 68, 0.6)', 'rgba(245, 158, 11, 0.6)', 'rgba(16, 185, 129, 0.6)', 'rgba(59, 130, 246, 0.6)', 'rgba(147, 51, 234, 0.6)'], borderColor: ['rgb(239, 68, 68)', 'rgb(245, 158, 11)', 'rgb(16, 185, 129)', 'rgb(59, 130, 246)', 'rgb(147, 51, 234)'], borderWidth: 1 }] },
                options: { ...chartOptions, scales: { x: { title: { display: true, text: 'Niveau d\'humeur', color: '#6B7280' }, ticks: { color: '#6B7280' }, grid: { display: false } }, y: { beginAtZero: true, title: { display: true, text: 'Nombre d\'entrées', color: '#6B7280' }, ticks: { color: '#6B7280', precision: 0 }, grid: { color: 'rgba(107, 114, 128, 0.1)' } } } }
            });

            const sleepCtx = document.getElementById('sleepChart').getContext('2d');
            if (sleepChartInstance) sleepChartInstance.destroy();
            sleepChartInstance = new Chart(sleepCtx, {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'Sommeil (heures)', data: [], borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.2)', tension: 0.1, fill: true }] },
                options: { ...chartOptions, plugins: { ...chartOptions.plugins, tooltip: { callbacks: { label: function(context) { return `${context.dataset.label}: ${context.raw} heures`; } } } }, scales: { ...chartOptions.scales, y: { ...chartOptions.scales.y, title: { display: true, text: 'Heures de sommeil', color: '#6B7280' } } } }
            });

            const exerciseCtx = document.getElementById('exerciseChart').getContext('2d');
            if (exerciseChartInstance) exerciseChartInstance.destroy();
            exerciseChartInstance = new Chart(exerciseCtx, {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'Exercice (minutes)', data: [], borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.2)', tension: 0.1, fill: true }] },
                options: { ...chartOptions, plugins: { ...chartOptions.plugins, tooltip: { callbacks: { label: function(context) { return `${context.dataset.label}: ${context.raw} minutes`; } } } }, scales: { ...chartOptions.scales, y: { ...chartOptions.scales.y, title: { display: true, text: 'Minutes d\'exercice', color: '#6B7280' } } } }
            });

            const waterCtx = document.getElementById('waterChart').getContext('2d');
            if (waterChartInstance) waterChartInstance.destroy();
            waterChartInstance = new Chart(waterCtx, {
                type: 'bar',
                data: { labels: [], datasets: [{ label: 'Eau (verres)', data: [], backgroundColor: 'rgba(0, 188, 212, 0.6)', borderColor: 'rgb(0, 188, 212)', borderWidth: 1 }] },
                options: { ...chartOptions, plugins: { ...chartOptions.plugins, tooltip: { callbacks: { label: function(context) { return `${context.dataset.label}: ${context.raw} verres`; } } } }, scales: { ...chartOptions.scales, y: { ...chartOptions.scales.y, title: { display: true, text: 'Verres d\'eau', color: '#6B7280' } } } }
            });

            const expenseCategoryCtx = document.getElementById('expenseCategoryChart').getContext('2d');
            if (expenseCategoryChartInstance) expenseCategoryChartInstance.destroy();
            expenseCategoryChartInstance = new Chart(expenseCategoryCtx, {
                type: 'pie',
                data: { labels: [], datasets: [{ data: [], backgroundColor: [], borderColor: 'white', borderWidth: 2 }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'right', labels: { color: '#6B7280' } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: €${value.toFixed(2)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderExpenseCategoryChart() {
            const expenseCategories = {};
            appData.expenses.filter(e => e.amount < 0).forEach(expense => {
                const category = appData.categories.find(cat => cat.id === expense.category);
                const categoryName = category ? category.name : 'Autre';
                if (!expenseCategories[categoryName]) {
                    expenseCategories[categoryName] = 0;
                }
                expenseCategories[categoryName] += Math.abs(expense.amount);
            });
            const expenseChartLabels = Object.keys(expenseCategories);
            const expenseChartData = Object.values(expenseCategories);
            const expenseChartColors = expenseChartLabels.map(label => {
                const category = appData.categories.find(cat => cat.name === label);
                return category ? category.color : '#64748b';
            });

            expenseCategoryChartInstance.data.labels = expenseChartLabels;
            expenseCategoryChartInstance.data.datasets[0].data = expenseChartData;
            expenseCategoryChartInstance.data.datasets[0].backgroundColor = expenseChartColors;
            expenseCategoryChartInstance.update();
        }

        function updateCharts() {
            const weightData = appData.wellness
                .filter(entry => entry.type === 'weight')
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .map(entry => ({ x: entry.date, y: entry.value }));
            weightChartInstance.data.labels = weightData.map(d => d.x);
            weightChartInstance.data.datasets[0].data = weightData.map(d => d.y);
            weightChartInstance.update();

            const moodCounts = { '1': 0, '2': 0, '3': 0, '4': 0, '5': 0 };
            appData.wellness.filter(entry => entry.type === 'mood').forEach(entry => {
                if (moodCounts.hasOwnProperty(entry.value)) {
                    moodCounts[entry.value]++;
                }
            });
            moodChartInstance.data.datasets[0].data = Object.values(moodCounts);
            moodChartInstance.update();

            const sleepData = appData.wellness
                .filter(entry => entry.type === 'sleep')
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .map(entry => ({ x: entry.date, y: entry.value }));
            sleepChartInstance.data.labels = sleepData.map(d => d.x);
            sleepChartInstance.data.datasets[0].data = sleepData.map(d => d.y);
            sleepChartInstance.update();

            const exerciseData = appData.wellness
                .filter(entry => entry.type === 'exercise')
                .sort((a, b) => new Date(a.date) - new Date(b.date))
                .map(entry => ({ x: entry.date, y: entry.value }));
            exerciseChartInstance.data.labels = exerciseData.map(d => d.x);
            exerciseChartInstance.data.datasets[0].data = exerciseData.map(d => d.y);
            exerciseChartInstance.update();

            const waterData = appData.wellness
                .filter(entry => entry.type === 'water')
                .sort((a, b) => new Date(a.date) - new Date(b.date));
            const aggregatedWater = {};
            waterData.forEach(entry => {
                const date = entry.date;
                if (!aggregatedWater[date]) {
                    aggregatedWater[date] = 0;
                }
                aggregatedWater[date] += entry.value;
            });
            const waterLabels = Object.keys(aggregatedWater).sort();
            const waterValues = waterLabels.map(date => aggregatedWater[date]);

            waterChartInstance.data.labels = waterLabels;
            waterChartInstance.data.datasets[0].data = waterValues;
            waterChartInstance.update();

            renderExpenseCategoryChart();
        }

        // Drag and Drop Logic
        let draggedElement = null;
        let draggedDataId = null;
        let currentDragListType = null;

        function addDragAndDropListeners(containerElement, listType) {
            containerElement.querySelectorAll('.draggable').forEach(item => {
                item.addEventListener('dragstart', (e) => {
                    draggedElement = item;
                    draggedDataId = item.dataset.id;
                    currentDragListType = listType;
                    setTimeout(() => item.classList.add('dragging'), 0);
                    e.dataTransfer.effectAllowed = 'move';
                });

                item.addEventListener('dragend', () => {
                    if (draggedElement) {
                        draggedElement.classList.remove('dragging');
                    }
                    draggedElement = null;
                    draggedDataId = null;
                    currentDragListType = null;
                    containerElement.querySelectorAll('.draggable').forEach(el => {
                        el.classList.remove('drag-over-top', 'drag-over-bottom');
                    });
                });

                item.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if (draggedElement && draggedElement !== item && currentDragListType === listType) {
                        const bounding = item.getBoundingClientRect();
                        const offset = bounding.y + (bounding.height / 2);

                        containerElement.querySelectorAll('.draggable').forEach(el => {
                            el.classList.remove('drag-over-top', 'drag-over-bottom');
                        });

                        if (e.clientY < offset) {
                            item.classList.add('drag-over-top');
                        } else {
                            item.classList.add('drag-over-bottom');
                        }
                    }
                });

                item.addEventListener('dragleave', () => {
                    item.classList.remove('drag-over-top', 'drag-over-bottom');
                });

                item.addEventListener('drop', async (e) => { // Added async here
                    e.preventDefault();
                    item.classList.remove('drag-over-top', 'drag-over-bottom');

                    if (draggedElement === null || draggedElement === item || currentDragListType !== listType) return;

                    const targetId = item.dataset.id;
                    const isBefore = e.clientY < item.getBoundingClientRect().y + (item.getBoundingClientRect().height / 2);

                    await reorderData(currentDragListType, draggedDataId, targetId, isBefore); // Await reorderData
                });
            });

            containerElement.addEventListener('dragover', (e) => {
                e.preventDefault();
            });

            containerElement.addEventListener('drop', async (e) => { // Added async here
                e.preventDefault();
                if (draggedElement && !e.target.closest('.draggable') && currentDragListType === listType) {
                    await reorderData(currentDragListType, draggedDataId, null, false); // Await reorderData
                }
            });
        }

        async function reorderData(listType, movedItemId, targetItemId, isBefore) { // Added async here
            let targetArray;
            if (listType === 'notesAndLists') {
                targetArray = [...appData.notes.map(n => ({ ...n, type: 'note' })), ...appData.lists.map(l => ({ ...l, type: 'list' }))];
            } else {
                targetArray = appData[listType];
            }

            const movedItemIndex = targetArray.findIndex(item => item.id === movedItemId);
            if (movedItemIndex === -1) return;

            const [removed] = targetArray.splice(movedItemIndex, 1);

            if (targetItemId === null) {
                targetArray.push(removed);
            } else {
                let targetIndex = targetArray.findIndex(item => item.id === targetItemId);
                if (targetIndex === -1) return;

                if (isBefore) {
                    targetArray.splice(targetIndex, 0, removed);
                } else {
                    targetArray.splice(targetIndex + 1, 0, removed);
                }
            }

            if (listType === 'notesAndLists') {
                appData.notes = targetArray.filter(item => item.type === 'note');
                appData.lists = targetArray.filter(item => item.type === 'list');
            } else {
                appData[listType] = targetArray;
            }

            await saveData(); // Save changes to GitHub
            switch (listType) {
                case 'todos': renderTodos(); break;
                case 'notesAndLists': renderNotes(); break;
                case 'expenses': renderExpenses(); break;
            }
        }

        // Remplir les dropdowns de catégories (pour les modales)
        function populateCategoryDropdowns() {
            const todoCategorySelect = document.getElementById('todoCategory');
            const expenseCategorySelect = document.getElementById('expenseCategory');

            [todoCategorySelect, expenseCategorySelect].forEach(selectElement => {
                if (selectElement) {
                    const currentSelectedValue = selectElement.value;
                    selectElement.innerHTML = '';
                    appData.categories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category.id;
                        option.textContent = category.name;
                        selectElement.appendChild(option);
                    });
                    selectElement.value = currentSelectedValue || (appData.categories[0] ? appData.categories[0].id : '');
                }
            });
        }

        // Remplir les dropdowns de provenances (pour les modales)
        function populateOriginDropdowns() {
            const expenseOriginSelect = document.getElementById('expenseOrigin');
            const incomeOriginSelect = document.getElementById('incomeOrigin');

            [expenseOriginSelect, incomeOriginSelect].forEach(selectElement => {
                if (selectElement) {
                    const currentSelectedValue = selectElement.value;
                    selectElement.innerHTML = '';
                    appData.origins.forEach(origin => {
                        const option = document.createElement('option');
                        option.value = origin.id;
                        option.textContent = origin.name;
                        selectElement.appendChild(option);
                    });
                    selectElement.value = currentSelectedValue || (appData.origins[0] ? appData.origins[0].id : '');
                }
            });
        }

        // Afficher les catégories dans la sidebar avec modification/suppression
        function renderCategoriesDisplay() {
            categoriesListDisplay.innerHTML = '';
            appData.categories.forEach(category => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between bg-purple-50 p-2 rounded-lg';
                div.innerHTML = `
                    <span class="px-2 py-0.5 rounded-full text-xs font-medium" style="background-color: ${category.color}; color: white;">
                        ${category.name}
                    </span>
                    <div>
                        <button onclick="editCategory('${category.id}')" class="text-purple-600 hover:text-purple-800 mr-2">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="confirmDeletion('category', '${category.id}')" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                categoriesListDisplay.appendChild(div);
            });
        }

        function editCategory(id) {
            const category = appData.categories.find(cat => cat.id === id);
            if (category) {
                document.getElementById('categoryId').value = category.id;
                document.getElementById('categoryName').value = category.name;
                document.getElementById('categoryColor').value = category.color;
                categoryModal.classList.remove('hidden');
            }
        }

        // Afficher les provenances dans la sidebar avec modification/suppression
        function renderOriginsDisplay() {
            originsListDisplay.innerHTML = '';
            appData.origins.forEach(origin => {
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between bg-purple-50 p-2 rounded-lg';
                div.innerHTML = `
                    <span class="px-2 py-0.5 rounded-full text-xs font-medium" style="background-color: ${origin.color}; color: white;">
                        ${origin.name}
                    </span>
                    <div>
                        <button onclick="editOrigin('${origin.id}')" class="text-purple-600 hover:text-purple-800 mr-2">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="confirmDeletion('origin', '${origin.id}')" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                originsListDisplay.appendChild(div);
            });
        }

        function editOrigin(id) {
            const origin = appData.origins.find(org => org.id === id);
            if (origin) {
                document.getElementById('originId').value = origin.id;
                document.getElementById('originName').value = origin.name;
                document.getElementById('originColor').value = origin.color;
                originModal.classList.remove('hidden');
            }
        }

        // Fonction pour confirmer la suppression
        function confirmDeletion(type, id) {
            itemToDelete = { type, id };
            document.getElementById('confirmMessage').textContent = `Êtes-vous sûr de vouloir supprimer cet élément (${type}) ?`;
            confirmModal.classList.remove('hidden');
        }

    </script>
</body>
</html>
